{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.outfit.name }} - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/social.css' %}">
{% endblock %}

{% block content %}
<div class="post-detail-layout">
    <div class="post-detail-main">
        <div class="post-detail-card content-section">
            <div class="post-header">
                <a href="{% url 'social:profile' post.user.id %}" class="post-user">
                    <div class="user-avatar">{{ post.user.first_name|slice:":1"|upper }}</div>
                    <span class="user-name">{{ post.user.get_full_name }}</span>
                </a>
                <span class="post-time">{{ post.created_at|timesince }} ago</span>
                {% if post.user == request.user %}
                <form id="delete-post-form-{{ post.id }}" method="post" action="{% url 'social:delete_post' post.id %}" style="margin-left: auto;">
                    {% csrf_token %}
                    <button type="button" class="btn-text-danger delete-trigger" data-form-id="delete-post-form-{{ post.id }}" data-item-name="cette publication">Supprimer</button>
                </form>
                {% endif %}
            </div>

            <div class="post-outfit-full">
                <a href="{% url 'outfits:outfit_detail' post.outfit.id %}" class="outfit-link-large">
                    <h2>{{ post.outfit.name }}</h2>
                </a>
                <div class="outfit-items-grid">
                    {% for item in post.outfit.items.all %}
                    <div class="outfit-item-card">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}">
                        {% else %}
                        <div class="item-placeholder"></div>
                        {% endif %}
                        <div class="item-info">
                            <p class="item-name">{{ item.name }}</p>
                            <span class="item-category">{{ item.get_category_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="post-actions">
                <form method="post" action="{% url 'social:toggle_like' post.id %}" class="like-form">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if is_liked %}liked{% endif %}">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-count">{{ post.likes_count }}</span>
                    </button>
                </form>
                <div class="action-btn">
                    <span class="action-icon">üí¨</span>
                    <span class="action-count">{{ post.comments_count }}</span>
                </div>
                <form method="post" action="{% url 'social:toggle_save' post.id %}" class="save-form">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if is_saved %}saved{% endif %}">
                        <span class="action-icon">üîñ</span>
                    </button>
                </form>
            </div>

            {% if post.caption %}
            <div class="post-caption">
                <strong>{{ post.user.get_full_name }}</strong> {{ post.caption }}
            </div>
            {% endif %}

            {% if post.hashtags %}
            <div class="post-hashtags">
                {{ post.hashtags }}
            </div>
            {% endif %}
        </div>

        <div class="comments-section content-section">
            <h3>Comments</h3>
            
            <form method="post" action="{% url 'social:add_comment' post.id %}" class="comment-form">
                {% csrf_token %}
                <textarea name="content" placeholder="Add a comment..." rows="2" required></textarea>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>

            <div class="comments-list">
                {% for comment in comments %}
                <div class="comment-item">
                    <a href="{% url 'social:profile' comment.user.id %}" class="comment-user">
                        <div class="user-avatar-sm">{{ comment.user.first_name|slice:":1"|upper }}</div>
                        <strong>{{ comment.user.get_full_name }}</strong>
                    </a>
                    <p class="comment-content">{{ comment.content }}</p>
                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    {% if comment.user == request.user %}
                    <form id="delete-comment-form-{{ comment.id }}" method="post" action="{% url 'social:delete_comment' comment.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="button" class="btn-text-danger delete-trigger" data-form-id="delete-comment-form-{{ comment.id }}" data-item-name="ce commentaire">Supprimer</button>
                    </form>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No comments yet. Be the first to comment!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
<!-- Delete Confirmation Modal -->
<div id="confirm-modal" class="modal-overlay" style="display:none;">
    <div class="modal-card content-section">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h2 class="modal-title">Confirmer la suppression</h2>
        <p class="modal-text">√ätes-vous s√ªr de vouloir supprimer <strong id="modal-item-name"></strong> ?</p>
        <p class="modal-subtext">Cette action est irr√©versible.</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" id="modal-cancel">Annuler</button>
            <button type="button" class="btn btn-primary btn-danger-strong" id="modal-confirm">Supprimer d√©finitivement</button>
        </div>
    </div>
    
</div>

{% block extra_js %}
{{ block.super }}
<script>
(function(){
    const modal = document.getElementById('confirm-modal');
    const nameSpan = document.getElementById('modal-item-name');
    const btnCancel = document.getElementById('modal-cancel');
    const btnConfirm = document.getElementById('modal-confirm');
    let formToSubmit = null;

    document.querySelectorAll('.delete-trigger').forEach(btn => {
        btn.addEventListener('click', () => {
            const formId = btn.getAttribute('data-form-id');
            const itemName = btn.getAttribute('data-item-name') || 'cet √©l√©ment';
            formToSubmit = document.getElementById(formId);
            if (nameSpan) nameSpan.textContent = itemName;
            modal.style.display = 'flex';
        });
    });

    function closeModal(){
        modal.style.display = 'none';
        formToSubmit = null;
    }

    btnCancel.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && modal.style.display === 'flex') closeModal(); });
    btnConfirm.addEventListener('click', () => { if (formToSubmit) formToSubmit.submit(); });
})();
</script>
{% endblock %}
{% endblock %}
