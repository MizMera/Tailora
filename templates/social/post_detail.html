{% extends 'base.html' %}
{% load static %}
{% load custom_filters %} 
{% block title %}{{ post.outfit.name }} - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/social.css' %}">
<style>
    .ai-enhanced-image {
        border: 3px solid #ff4081;
        box-shadow: 0 0 10px rgba(255, 64, 129, 0.3);
    }
    
    .ai-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: #ff4081;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        z-index: 10;
    }
    
    .outfit-item-card {
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="post-detail-layout">
    <div class="post-detail-main">
        <div class="post-detail-card content-section">
            <div class="post-header">
                <a href="{% url 'social:profile' post.user.id %}" class="post-user">
                    <div class="user-avatar">{{ post.user.first_name|slice:":1"|upper }}</div>
                    <span class="user-name">{{ post.user.get_full_name }}</span>
                </a>
                <span class="post-time">{{ post.created_at|timesince }} ago</span>
                {% if post.user == request.user %}
                <div class="post-owner-actions" style="margin-left: auto; display: flex; gap: 10px;">
                    <a href="{% url 'social:edit_post' post.id %}" class="btn btn-secondary btn-sm">‚úèÔ∏è Edit</a>
                    <form id="delete-post-form-{{ post.id }}" method="post" action="{% url 'social:delete_post' post.id %}" style="margin-left: auto;">
                        {% csrf_token %}
                        <button type="button" class="btn-text-danger delete-trigger" data-form-id="delete-post-form-{{ post.id }}" data-item-name="this post">Delete</button>
                    </form>
                </div>
                {% endif %}
            </div>

            <div class="post-outfit-full">
                <a href="{% url 'outfits:outfit_detail' post.outfit.id %}" class="outfit-link-large">
                    <h2>{{ post.outfit.name }}</h2>
                </a>
                <div class="outfit-items-grid">
                    {% for item in post.outfit.items.all %}
                    <div class="outfit-item-card">
                        {% if post.enhanced_images and item.id|stringformat:"s" in post.enhanced_images %}
                            <!-- Image am√©lior√©e par AI -->
                            <img src="/media/{{ post.enhanced_images|get_item:item.id|stringformat:'s' }}" 
                                 alt="{{ item.name }}" 
                                 class="ai-enhanced-image">
                            <div class="ai-badge">AI üé®</div>
                        {% elif item.image %}
                            <!-- Image originale -->
                            <img src="{{ item.image.url }}" alt="{{ item.name }}">
                        {% else %}
                            <div class="item-placeholder"></div>
                        {% endif %}
                        <div class="item-info">
                            <p class="item-name">{{ item.name }}</p>
                            <span class="item-category">{{ item.get_category_display }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="post-actions">
                <form method="post" action="{% url 'social:toggle_like' post.id %}" class="like-form">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if post.is_liked %}liked{% endif %}">
                        <span class="action-icon">‚ù§Ô∏è</span>
                        <span class="action-count">{{ post.likes_count }}</span>
                    </button>
                </form>
                <div class="action-btn">
                    <span class="action-icon">üí¨</span>
                    <span class="action-count">{{ post.comments_count }}</span>
                </div>
                <form method="post" action="{% url 'social:toggle_save' post.id %}" class="save-form">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if post.is_saved %}saved{% endif %}">
                        <span class="action-icon">üîñ</span>
                        <span class="action-count">{{ post.saves_count }}</span>
                    </button>
                </form>
            </div>

            {% if post.caption %}
            <div class="post-caption">
                <strong>{{ post.user.get_full_name }}</strong> {{ post.caption }}
            </div>
            {% endif %}

            {% if post.hashtags %}
            <div class="post-hashtags">
                {% for tag in post.hashtags %}
                    <span class="hashtag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="comments-section content-section">
            <h3>Comments</h3>
            
            <form method="post" action="{% url 'social:add_comment' post.id %}" class="comment-form">
                {% csrf_token %}
                <textarea name="content" placeholder="Add a comment..." rows="2" required></textarea>
                <button type="submit" class="btn btn-primary">Post Comment</button>
            </form>

            <div class="comments-list">
                {% for comment in comments %}
                <div class="comment-item">
                    <a href="{% url 'social:profile' comment.user.id %}" class="comment-user">
                        <div class="user-avatar-sm">{{ comment.user.first_name|slice:":1"|upper }}</div>
                        <strong>{{ comment.user.get_full_name }}</strong>
                    </a>
                    <p class="comment-content">{{ comment.content }}</p>
                    <span class="comment-time">{{ comment.created_at|timesince }} ago</span>
                    {% if comment.user == request.user %}
                    <form id="delete-comment-form-{{ comment.id }}" method="post" action="{% url 'social:delete_comment' comment.id %}" style="display: inline;">
                        {% csrf_token %}
                        <button type="button" class="btn-text-danger delete-trigger" data-form-id="delete-comment-form-{{ comment.id }}" data-item-name="this comment">Delete</button>
                    </form>
                    {% endif %}
                </div>
                {% empty %}
                <p class="text-muted">No comments yet. Be the first to comment!</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}