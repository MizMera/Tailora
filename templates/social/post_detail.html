{% extends 'base.html' %}
{% load static %}

{% block title %}{{ post.outfit.name }} - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wardrobe.css' %}">
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<link rel="stylesheet" href="{% static 'css/social_v2.css' %}">
{% endblock %}

{% block container_class %}page-reveal{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <a href="{% url 'social:feed' %}" style="font-family: 'Inter', sans-serif; font-size: 14px; color: #757575; text-decoration: none; display: inline-block; margin-bottom: 8px;">&larr; Back to Feed</a>
            <h1 class="page-title">{{ post.outfit.name }}</h1>
            <p class="page-subtitle">Posted by {{ post.user.get_full_name }} â€¢ {{ post.created_at|timesince }} ago</p>
        </div>
        {% if post.user == request.user %}
        <div style="display: flex; gap: 12px;">
            <a href="{% url 'social:edit_post' post.id %}" class="btn btn-secondary">Edit</a>
            <form id="delete-post-form-{{ post.id }}" method="post" action="{% url 'social:delete_post' post.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="button" class="btn btn-primary delete-trigger" data-form-id="delete-post-form-{{ post.id }}" data-item-name="this post" style="background: #c62828; border-color: #c62828;">Delete</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div style="margin-bottom: 24px;">
    {% for message in messages %}
    <div class="alert {% if message.tags == 'error' %}alert-error{% else %}alert-success{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Main Content -->
<div style="max-width: 1200px; margin: 0 auto;">
<div class="content-section">
    <div style="display: grid; grid-template-columns: 1.2fr 1fr; gap: 40px;">
        <!-- Left Column: Outfit Images -->
        <div>
            <div style="background: #fafafa; border: 1px solid #e0e0e0; overflow: hidden; margin-bottom: 24px;">
                {% with items=post.outfit.items.all %}
                {% if items|length == 1 %}
                    <!-- Single Image -->
                    {% for item in items %}
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" style="width: 100%; height: auto; display: block; max-height: 600px; object-fit: contain;">
                        {% endif %}
                    {% endfor %}
                {% else %}
                    <!-- Multiple Images Grid -->
                    <div class="post-image-grid post-image-grid-{{ items|length }}" style="max-height: 600px;">
                        {% for item in items %}
                            {% if item.image %}
                            <div class="grid-image-wrapper">
                                <img src="{{ item.image.url }}" alt="{{ item.name }}" class="grid-image">
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endif %}
                {% endwith %}
            </div>
            
            <!-- Post Actions -->
            <div class="post-actions" style="display: flex; align-items: center; gap: 16px; padding: 16px 0; border-top: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0;">
                <form method="post" action="{% url 'social:toggle_like' post.id %}" class="inline-form">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if post.is_liked %}liked{% endif %}" title="Like">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if post.is_liked %}#ed4956{% else %}none{% endif %}" stroke="{% if post.is_liked %}#ed4956{% else %}currentColor{% endif %}" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                        <span style="font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600; margin-left: 4px;">{{ post.likes_count }}</span>
                    </button>
                </form>
                <a href="#comments" class="action-btn" title="Comments">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                    </svg>
                    <span style="font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600; margin-left: 4px;">{{ post.comments_count }}</span>
                </a>
                <form method="post" action="{% url 'social:toggle_save' post.id %}" class="inline-form" style="margin-left: auto;">
                    {% csrf_token %}
                    <button type="submit" class="action-btn {% if post.is_saved %}saved{% endif %}" title="Save">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="{% if post.is_saved %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Right Column: Post Info & Comments -->
        <div>
            <!-- Post Details -->
            <div class="settings-section" style="margin-bottom: 32px;">
                <h3 class="section-title">Post Details</h3>
                
                <div style="display: grid; gap: 16px;">
                    <div>
                        <label style="display: block; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; color: #757575; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Posted by</label>
                        <a href="{% url 'social:profile' post.user.id %}" style="display: flex; align-items: center; gap: 12px; text-decoration: none; color: #2c2c2c;">
                            <div class="user-avatar">{{ post.user.first_name|slice:":1"|upper }}</div>
                            <span style="font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600;">{{ post.user.get_full_name }}</span>
                        </a>
                    </div>

                    {% if post.caption %}
                    <div style="padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <label style="display: block; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; color: #757575; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Caption</label>
                        <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #2c2c2c; line-height: 1.6; margin: 0;">{{ post.caption }}</p>
                    </div>
                    {% endif %}

                    {% if post.hashtags %}
                    <div style="padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <label style="display: block; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; color: #757575; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Tags</label>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            {% for tag in post.hashtags %}
                            <span style="padding: 4px 12px; background: #f4e9cf; color: #2c2c2c; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 500;">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div style="padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <label style="display: block; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; color: #757575; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Visibility</label>
                        <span style="padding: 4px 12px; background: #2c2c2c; color: #ffffff; font-size: 12px; font-weight: 600; text-transform: uppercase; display: inline-block;">{{ post.get_visibility_display }}</span>
                    </div>

                    <div style="padding-top: 12px; border-top: 1px solid #e0e0e0;">
                        <label style="display: block; font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 600; color: #757575; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px;">Outfit</label>
                        <a href="{% url 'outfits:outfit_detail' post.outfit.id %}" class="btn btn-secondary" style="width: 100%;">View Full Outfit Details</a>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="settings-section" id="comments">
                <h3 class="section-title">Comments ({{ post.comments_count }})</h3>
                
                <form method="post" action="{% url 'social:add_comment' post.id %}" style="margin-bottom: 24px;">
                    {% csrf_token %}
                    <textarea name="content" placeholder="Add a comment..." rows="3" class="input-textarea" required style="width: 100%; margin-bottom: 12px;"></textarea>
                    <button type="submit" class="btn btn-primary">Post Comment</button>
                </form>

                <div style="display: grid; gap: 16px;">
                    {% for comment in comments %}
                    <div style="padding: 16px; background: #fafafa; border: 1px solid #e0e0e0;">
                        <div style="display: flex; align-items: start; gap: 12px; margin-bottom: 8px;">
                            <a href="{% url 'social:profile' comment.user.id %}" style="text-decoration: none;">
                                <div class="user-avatar" style="width: 32px; height: 32px; font-size: 14px;">{{ comment.user.first_name|slice:":1"|upper }}</div>
                            </a>
                            <div style="flex: 1;">
                                <a href="{% url 'social:profile' comment.user.id %}" style="font-family: 'Inter', sans-serif; font-size: 14px; font-weight: 600; color: #2c2c2c; text-decoration: none;">{{ comment.user.get_full_name }}</a>
                                <span style="font-family: 'Inter', sans-serif; font-size: 12px; color: #757575; margin-left: 8px;">{{ comment.created_at|timesince }} ago</span>
                                <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #2c2c2c; margin: 8px 0 0 0; line-height: 1.5;">{{ comment.content }}</p>
                            </div>
                            {% if comment.user == request.user %}
                            <form id="delete-comment-form-{{ comment.id }}" method="post" action="{% url 'social:delete_comment' comment.id %}" style="margin: 0;">
                                {% csrf_token %}
                                <button type="button" class="delete-trigger" data-form-id="delete-comment-form-{{ comment.id }}" data-item-name="this comment" style="background: none; border: none; color: #c62828; font-family: 'Inter', sans-serif; font-size: 12px; cursor: pointer; text-decoration: underline;">Delete</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                    {% empty %}
                    <p style="text-align: center; padding: 24px; font-family: 'Inter', sans-serif; font-size: 14px; color: #757575;">No comments yet. Be the first to comment!</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
</div>
{% endblock %}
