{% extends 'base.html' %}

{% block title %}Check Scheduled Posts - Tailora{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Scheduled Posts Check</h1>
        <p class="page-subtitle">Current time: {{ now }}</p>
    </div>
</div>

<div style="max-width: 800px; margin: 0 auto;">
    <div class="content-section">
        
        {% if published %}
        <div class="alert alert-success">
            <h4>âœ… Published {{ count }} posts</h4>
        </div>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <thead>
                <tr style="background: #f4e9cf;">
                    <th style="padding: 10px; text-align: left;">Draft</th>
                    <th style="padding: 10px; text-align: left;">Outfit</th>
                    <th style="padding: 10px; text-align: left;">Scheduled For</th>
                    <th style="padding: 10px; text-align: left;">Post</th>
                </tr>
            </thead>
            <tbody>
                {% for item in published %}
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px;">{{ item.draft.id|truncatechars:10 }}</td>
                    <td style="padding: 10px;">{{ item.draft.outfit.name }}</td>
                    <td style="padding: 10px;">{{ item.draft.scheduled_for }}</td>
                    <td style="padding: 10px;">
                        <a href="{% url 'social:post_detail' item.post.id %}" class="btn btn-sm btn-primary">
                            View Post
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% elif scheduled_drafts %}
        <h3>Upcoming Scheduled Posts ({{ scheduled_drafts|length }})</h3>
        
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <thead>
                <tr style="background: #f4e9cf;">
                    <th style="padding: 10px; text-align: left;">Outfit</th>
                    <th style="padding: 10px; text-align: left;">Caption</th>
                    <th style="padding: 10px; text-align: left;">Scheduled For</th>
                    <th style="padding: 10px; text-align: left;">Status</th>
                </tr>
            </thead>
            <tbody>
                {% for draft in scheduled_drafts %}
                <tr style="border-bottom: 1px solid #e0e0e0; {% if draft.scheduled_for <= now %}background: #ffebee;{% endif %}">
                    <td style="padding: 10px;">{{ draft.outfit.name }}</td>
                    <td style="padding: 10px;">{{ draft.caption|truncatechars:50 }}</td>
                    <td style="padding: 10px;">
                        {{ draft.scheduled_for }}
                        {% if draft.scheduled_for <= now %}
                        <span style="color: #c62828; font-weight: bold;">(OVERDUE)</span>
                        {% endif %}
                    </td>
                    <td style="padding: 10px;">
                        {% if draft.scheduled_for <= now %}
                        <form method="post" style="display: inline;">
                            {% csrf_token %}
                            <input type="hidden" name="draft_id" value="{{ draft.id }}">
                            <button type="submit" class="btn btn-sm btn-primary">
                                Publish Now
                            </button>
                        </form>
                        {% else %}
                        <span style="color: #4caf50;">Scheduled</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <form method="post" style="margin-top: 20px;">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" name="check_all" value="true">
                Check and Publish All Overdue
            </button>
        </form>
        
        {% else %}
        <div class="alert alert-info">
            <h4>No scheduled posts found</h4>
            <p>All scheduled posts have been published or there are none scheduled.</p>
        </div>
        {% endif %}
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
            <h4>Auto-check System</h4>
            <p>The system automatically checks for scheduled posts:</p>
            <ul>
                <li>Every minute when users visit any page (middleware)</li>
                <li>Via JavaScript AJAX calls every minute on feed page</li>
                <li>Manually via this page</li>
            </ul>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <a href="{% url 'social:draft_list' %}" class="btn btn-secondary">View Drafts</a>
                <a href="{% url 'social:feed' %}" class="btn btn-primary">Go to Feed</a>
                <button onclick="forceCheck()" class="btn btn-info">Force Check Now (AJAX)</button>
            </div>
        </div>
    </div>
</div>

<script>
function forceCheck() {
    fetch('{% url "social:check_scheduled_ajax" %}', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success' && data.count > 0) {
            alert(`Published ${data.count} posts! Page will reload.`);
            window.location.reload();
        } else {
            alert(data.message || 'No posts to publish.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error checking scheduled posts.');
    });
}

// Auto-check every minute
setInterval(forceCheck, 60000);
</script>
{% endblock %}