{% extends 'base.html' %}
{% load static %}

{% block title %}Add an Item - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/components.css' %}">
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    /* =========================================
       THEME VARIABLES
       ========================================= */
    :root {
        --bg-color: #f8f8f8;
        --card-bg: #ffffff;
        --text-main: #1f1e1e;
        --text-muted: #757575;
        --border-color: #e0e0e0;
        --accent-color: #2c2c2c;
        --success-bg: #def7ec;
        --success-text: #03543f;
        --error-bg: #fde8e8;
        --error-text: #9b1c1c;
        --font-heading: 'Istok Web', sans-serif;
        --font-body: 'Inter', sans-serif;
    }

    /* =========================================
       LAYOUT
       ========================================= */
    .upload-wrapper {
        background-color: var(--bg-color);
        min-height: 100vh;
        padding: 40px 24px;
    }

    .upload-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* =========================================
       PAGE HEADER
       ========================================= */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 32px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 24px;
    }

    .header-content {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .back-link {
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-muted);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
    }

    .back-link:hover {
        color: var(--text-main);
    }

    .page-title {
        font-family: var(--font-heading);
        font-size: 32px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        line-height: 1.2;
    }

    .slots-info {
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text-muted);
        margin: 0;
    }

    /* =========================================
       BUTTONS
       ========================================= */
    .btn {
        border-radius: 0;
        padding: 12px 24px;
        font-family: var(--font-body);
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 1px solid transparent;
    }

    .btn-primary {
        background: var(--text-main);
        color: #fff;
        border-color: var(--text-main);
    }

    .btn-primary:hover {
        background: #000;
        transform: translateY(-1px);
    }

    .btn-secondary {
        background: var(--card-bg);
        color: var(--text-main);
        border-color: var(--border-color);
    }

    .btn-secondary:hover {
        border-color: var(--text-main);
        background: #f9f9f9;
    }

    .btn-danger {
        background: #fff;
        color: var(--error-text);
        border-color: var(--error-text);
    }

    .btn-danger:hover {
        background: var(--error-bg);
    }

    /* =========================================
       FORM SECTIONS
       ========================================= */
    .form-section {
        background: var(--card-bg);
        padding: 32px;
        border: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .section-title {
        font-family: var(--font-heading);
        font-size: 16px;
        font-weight: 700;
        color: var(--text-main);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin: 0 0 24px 0;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    /* =========================================
       UPLOAD AREA
       ========================================= */
    .upload-area {
        padding: 48px 24px;
        background: #fafafa;
        border: 2px dashed var(--border-color);
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .upload-area:hover {
        border-color: var(--text-muted);
        background: #f5f5f5;
    }

    .upload-area.dragover {
        border-color: var(--text-main);
        background: #f0f0f0;
    }

    .upload-icon {
        margin-bottom: 16px;
    }

    .upload-title {
        font-family: var(--font-body);
        font-size: 16px;
        font-weight: 600;
        color: var(--text-main);
        margin: 0 0 8px 0;
    }

    .upload-hint {
        font-family: var(--font-body);
        font-size: 13px;
        color: var(--text-muted);
        margin: 0;
    }

    /* Image Preview */
    .image-preview {
        display: none;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        padding: 24px;
        background: #fafafa;
        border: 1px solid var(--border-color);
    }

    .image-preview img {
        max-width: 300px;
        max-height: 300px;
        border: 1px solid var(--border-color);
    }

    .image-actions {
        display: flex;
        gap: 12px;
    }

    /* =========================================
       AI ANALYSIS
       ========================================= */
    .ai-section {
        display: none;
        margin-top: 24px;
        padding: 24px;
        background: #f8f9fa;
        border: 1px solid var(--border-color);
    }

    .ai-loading {
        text-align: center;
        padding: 20px;
        font-family: var(--font-body);
        color: var(--text-muted);
    }

    .ai-results {
        display: none;
    }

    .ai-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }

    .ai-item {
        font-family: var(--font-body);
        font-size: 14px;
    }

    .ai-item strong {
        color: var(--text-main);
    }

    .ai-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 16px;
    }

    /* =========================================
       FORM CONTROLS
       ========================================= */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .form-grid-full {
        grid-column: 1 / -1;
    }

    @media (max-width: 600px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }

    .input-field {
        margin-bottom: 0;
    }

    .input-label {
        display: block;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    .input-label .required {
        color: var(--error-text);
    }

    .input-control {
        width: 100%;
        padding: 12px 16px;
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text-main);
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 0;
        transition: border-color 0.2s;
    }

    .input-control:focus {
        outline: none;
        border-color: var(--text-main);
    }

    .input-control::placeholder {
        color: #aaa;
    }

    textarea.input-control {
        resize: vertical;
        min-height: 100px;
    }

    .input-hint {
        display: block;
        font-family: var(--font-body);
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
    }

    /* Color Picker */
    .color-picker-group {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .color-picker {
        width: 60px;
        height: 44px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        padding: 0;
    }

    .color-preview {
        width: 24px;
        height: 24px;
        border: 1px solid var(--border-color);
    }

    /* Checkbox Grid */
    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
    }

    .checkbox-card {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 16px;
        background: #fafafa;
        border: 1px solid var(--border-color);
        cursor: pointer;
        transition: all 0.2s;
    }

    .checkbox-card:hover {
        border-color: var(--text-muted);
    }

    .checkbox-card input[type="checkbox"] {
        margin: 0;
    }

    .checkbox-card span {
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text-main);
    }

    .checkbox-card:has(input:checked) {
        background: var(--text-main);
        border-color: var(--text-main);
    }

    .checkbox-card:has(input:checked) span {
        color: #fff;
    }

    /* Secondhand Checkbox */
    .secondhand-label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 14px 16px;
        background: #fafafa;
        border: 1px solid var(--border-color);
        cursor: pointer;
        margin-top: 28px;
    }

    .secondhand-label span {
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text-main);
    }

    /* =========================================
       FORM ACTIONS
       ========================================= */
    .form-actions {
        display: flex;
        justify-content: flex-end;
        gap: 16px;
        padding-top: 24px;
        border-top: 1px solid var(--border-color);
        margin-top: 8px;
    }

    /* =========================================
       CROP MODAL
       ========================================= */
    .crop-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
    }

    .crop-modal-content {
        background-color: #fff;
        margin: 3% auto;
        width: 90%;
        max-width: 800px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .crop-header {
        padding: 20px 24px;
        background: var(--text-main);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .crop-header h2 {
        font-family: var(--font-heading);
        font-size: 18px;
        font-weight: 700;
        color: #f4e9cf;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .crop-close-btn {
        background: transparent;
        border: none;
        color: #f4e9cf;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        opacity: 0.8;
    }

    .crop-close-btn:hover {
        opacity: 1;
    }

    .crop-body {
        padding: 24px;
        max-height: 65vh;
        overflow: hidden;
        background: #fafafa;
    }

    .crop-hint {
        text-align: center;
        color: var(--text-muted);
        margin-bottom: 16px;
        font-family: var(--font-body);
        font-size: 14px;
    }

    .crop-container {
        max-height: 55vh;
        overflow: hidden;
        background: #f0f0f0;
        border: 1px solid var(--border-color);
    }

    .crop-footer {
        padding: 20px 24px;
        background: #fff;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 12px;
    }

    .crop-controls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .crop-control-btn {
        padding: 10px 16px;
        background: #fff;
        border: 1px solid var(--border-color);
        cursor: pointer;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-main);
        transition: all 0.2s;
    }

    .crop-control-btn:hover {
        background: #f0f0f0;
        border-color: var(--text-main);
    }

    .crop-apply-btn {
        padding: 12px 24px;
        background: var(--text-main);
        color: #f4e9cf;
        border: none;
        font-family: var(--font-body);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .crop-apply-btn:hover {
        background: #444;
    }

    /* Spinner Animation */
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--text-main);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
    }

    /* =========================================
       COMPRESSION MODAL
       ========================================= */
    .compress-modal {
        display: none;
        position: fixed;
        z-index: 10001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.85);
        align-items: center;
        justify-content: center;
    }

    .compress-modal-content {
        background-color: #fff;
        margin: 3% auto;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .compress-header {
        padding: 20px 24px;
        background: #f57c00;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .compress-header h2 {
        font-family: var(--font-heading);
        font-size: 18px;
        font-weight: 700;
        color: #fff;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .compress-close-btn {
        background: transparent;
        border: none;
        color: #fff;
        font-size: 28px;
        cursor: pointer;
        padding: 0;
        line-height: 1;
        opacity: 0.8;
    }

    .compress-close-btn:hover {
        opacity: 1;
    }

    .compress-body {
        padding: 24px;
    }

    .file-size-info {
        background: #fff3e0;
        border: 1px solid #ffe0b2;
        padding: 16px;
        margin-bottom: 20px;
    }

    .file-size-info p {
        margin: 0 0 8px 0;
        font-family: var(--font-body);
        font-size: 14px;
        color: var(--text-main);
    }

    .file-size-info .size-value {
        font-weight: 700;
        color: #e65100;
    }

    .compress-quality {
        margin-bottom: 20px;
    }

    .compress-quality label {
        display: block;
        font-family: var(--font-body);
        font-size: 13px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    .quality-slider {
        width: 100%;
        height: 6px;
        appearance: none;
        -webkit-appearance: none;
        background: #e0e0e0;
        outline: none;
    }

    .quality-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        background: var(--text-main);
        cursor: pointer;
    }

    .quality-value {
        display: inline-block;
        font-family: var(--font-body);
        font-size: 14px;
        font-weight: 600;
        color: var(--text-main);
        margin-left: 12px;
    }

    .compress-preview {
        display: flex;
        justify-content: space-between;
        padding: 12px 0;
        border-top: 1px solid var(--border-color);
        margin-top: 12px;
    }

    .compress-preview span {
        font-family: var(--font-body);
        font-size: 13px;
        color: var(--text-muted);
    }

    .compress-preview .new-size {
        font-weight: 600;
        color: #388e3c;
    }

    .compress-progress {
        display: none;
        margin-top: 16px;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4caf50, #8bc34a);
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        font-family: var(--font-body);
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
        margin-top: 8px;
    }

    .compress-footer {
        padding: 16px 24px;
        background: #fafafa;
        border-top: 1px solid var(--border-color);
        display: flex;
        justify-content: flex-end;
        gap: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-wrapper">
    <div class="upload-container">

        <!-- Page Header -->
        <header class="page-header">
            <div class="header-content">
                <a href="{% url 'wardrobe:wardrobe_gallery' %}" class="back-link">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back to Wardrobe
                </a>
                <h1 class="page-title">Add an Item</h1>
                <p class="slots-info">{{ remaining_slots }} / {{ max_items }} slots available</p>
            </div>
        </header>

        <!-- Main Form -->
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <!-- Image Upload Section -->
            <div class="form-section">
                <h3 class="section-title">Item Photo</h3>

                <div class="upload-area" id="upload-area">
                    <input type="file" id="image-input" name="image" accept="image/*" required style="display: none;">
                    <label for="image-input" class="upload-label" style="cursor: pointer; display: block;">
                        <div class="upload-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#757575">
                                <rect x="3" y="3" width="18" height="18" stroke-width="2" />
                                <circle cx="8.5" cy="8.5" r="1.5" fill="#757575" />
                                <path d="m21 15-5-5L5 21" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round" />
                            </svg>
                        </div>
                        <p class="upload-title">Click to add an image</p>
                        <p class="upload-hint">JPG or PNG (max 20 MB)</p>
                    </label>
                </div>

                <div id="image-preview" class="image-preview">
                    <img id="preview-img" src="" alt="Preview">
                    <div class="image-actions">
                        <button type="button" id="analyze-image-btn" class="btn btn-primary">Analyze with AI</button>
                        <button type="button" id="btn-remove-image" class="btn btn-danger">Remove</button>
                    </div>
                </div>

                <!-- AI Analysis Section -->
                <div class="ai-section" id="ai-analysis-section">
                    <h4
                        style="margin: 0 0 16px 0; font-family: var(--font-heading); font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px;">
                        AI Analysis</h4>
                    <div id="ai-loading" class="ai-loading" style="display: none;">
                        <span class="spinner"></span>
                        Analyzing image with AI...
                    </div>
                    <div id="ai-results" class="ai-results">
                        <div class="ai-grid">
                            <div class="ai-item"><strong>Detected:</strong> <span id="ai-item-type"></span></div>
                            <div class="ai-item"><strong>Confidence:</strong> <span id="ai-confidence"></span>%</div>
                            <div class="ai-item"><strong>Style:</strong> <span id="ai-style"></span></div>
                            <div class="ai-item"><strong>Material:</strong> <span id="ai-material"></span></div>
                        </div>
                        <div class="ai-item" style="margin-bottom: 16px;"><strong>Description:</strong> <span
                                id="ai-description"></span></div>
                        <div class="ai-buttons">
                            <button type="button" id="ai-apply-all" class="btn btn-primary">Apply All
                                Suggestions</button>
                            <button type="button" id="ai-apply-basic" class="btn btn-secondary">Apply Basic
                                Info</button>
                            <button type="button" id="ai-apply-color" class="btn btn-secondary">Apply Color</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>

                <div class="form-grid">
                    <div class="input-field">
                        <label for="name" class="input-label">Item Name <span class="required">*</span></label>
                        <input type="text" id="name" name="name" placeholder="e.g., Navy blue T-shirt" required
                            class="input-control">
                    </div>

                    <div class="input-field">
                        <label for="category" class="input-label">Category</label>
                        <select id="category" name="category" class="input-control">
                            <option value="">Select a category</option>
                            {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="input-field" style="grid-column: 1 / -1;">
                        <label for="description" class="input-label">Description</label>
                        <textarea id="description" name="description" placeholder="Describe this item..." rows="3"
                            class="input-control"></textarea>
                    </div>
                </div>
            </div>

            <!-- Color Section -->
            <div class="form-section">
                <h3 class="section-title">Color</h3>

                <div class="form-grid">
                    <div class="input-field">
                        <label for="color_hex" class="input-label">Pick a Color <span class="required">*</span></label>
                        <div class="color-picker-group">
                            <input type="color" id="color_hex" name="color_hex" value="#DAD3C2" class="color-picker">
                            <input type="text" id="color_hex_display" placeholder="#RRGGBB" class="input-control"
                                style="flex: 1; max-width: 120px;">
                            <span id="color-preview" class="color-preview" style="background: #DAD3C2;"></span>
                        </div>
                    </div>

                    <div class="input-field">
                        <label for="color" class="input-label">Color Name <span class="required">*</span></label>
                        <input type="text" id="color" name="color" placeholder="Auto-detected from color picker"
                            required class="input-control">
                        <span class="input-hint">Name auto-generated from hex, or enter custom name</span>
                    </div>
                </div>
            </div>

            <!-- Additional Details -->
            <div class="form-section">
                <h3 class="section-title">Additional Details</h3>

                <div class="form-grid">
                    <div class="input-field">
                        <label for="brand" class="input-label">Brand</label>
                        <input type="text" id="brand" name="brand" placeholder="e.g., Nike, Zara..."
                            class="input-control">
                    </div>

                    <div class="input-field">
                        <label for="material" class="input-label">Material</label>
                        <input type="text" id="material" name="material" placeholder="e.g., 100% Cotton"
                            class="input-control">
                    </div>

                    <div class="input-field">
                        <label for="pattern" class="input-label">Pattern</label>
                        <select id="pattern" name="pattern" class="input-control">
                            <option value="">None</option>
                            <option value="solid">Solid</option>
                            <option value="striped">Striped</option>
                            <option value="floral">Floral</option>
                            <option value="plaid">Plaid</option>
                            <option value="polka_dot">Polka dot</option>
                            <option value="geometric">Geometric</option>
                            <option value="animal">Animal</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="input-field">
                        <label for="condition" class="input-label">Condition</label>
                        <select id="condition" name="condition" class="input-control">
                            <option value="good">Good</option>
                            <option value="new">New</option>
                            <option value="excellent">Excellent</option>
                            <option value="fair">Fair</option>
                            <option value="worn">Worn</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Seasons and Occasions -->
            <div class="form-section">
                <h3 class="section-title">Seasons and Occasions</h3>

                <div class="input-field" style="margin-bottom: 24px;">
                    <label class="input-label">Seasons</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="spring">
                            <span>Spring</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="summer">
                            <span>Summer</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="fall">
                            <span>Fall</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="winter">
                            <span>Winter</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="all_seasons">
                            <span>All Seasons</span>
                        </label>
                    </div>
                </div>

                <div class="input-field">
                    <label class="input-label">Occasions</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="casual">
                            <span>Casual</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="formal">
                            <span>Formal</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="sport">
                            <span>Sport</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="party">
                            <span>Party</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="work">
                            <span>Work</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Purchase Information -->
            <div class="form-section">
                <h3 class="section-title">Purchase Information</h3>

                <div class="form-grid">
                    <div class="input-field">
                        <label for="purchase_date" class="input-label">Purchase Date</label>
                        <input type="date" id="purchase_date" name="purchase_date" class="input-control">
                    </div>

                    <div class="input-field">
                        <label for="purchase_price" class="input-label">Price (EUR)</label>
                        <input type="number" id="purchase_price" name="purchase_price" placeholder="0.00" step="0.01"
                            min="0" class="input-control">
                    </div>

                    <div class="input-field">
                        <label for="purchase_location" class="input-label">Purchase Location</label>
                        <input type="text" id="purchase_location" name="purchase_location"
                            placeholder="e.g., Zara, H&M, Thrifted..." class="input-control">
                    </div>

                    <div class="input-field">
                        <label class="secondhand-label">
                            <input type="checkbox" name="is_secondhand">
                            <span>Second-hand item</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="form-section">
                <h3 class="section-title">Tags</h3>

                <div class="input-field">
                    <label for="tags" class="input-label">Tags (comma-separated)</label>
                    <input type="text" id="tags" name="tags" placeholder="e.g., comfy, summer, blue"
                        class="input-control">
                    <span class="input-hint">Add keywords to improve search</span>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <a href="{% url 'wardrobe:wardrobe_gallery' %}" class="btn btn-secondary">Cancel</a>
                    <button type="submit" class="btn btn-primary">Add to My Wardrobe</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Image Cropper Modal -->
<div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
        <div class="crop-header">
            <h2>Crop Your Image</h2>
            <button type="button" id="closeCropModal" class="crop-close-btn">&times;</button>
        </div>
        <div class="crop-body">
            <p class="crop-hint">Adjust the crop area to focus on your clothing item</p>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Crop preview" style="max-width: 100%;">
            </div>
        </div>
        <div class="crop-footer">
            <div class="crop-controls">
                <button type="button" class="crop-control-btn" id="zoomIn">+ Zoom</button>
                <button type="button" class="crop-control-btn" id="zoomOut">- Zoom</button>
                <button type="button" class="crop-control-btn" id="rotateLeft">↺ Rotate</button>
                <button type="button" class="crop-control-btn" id="rotateRight">↻ Rotate</button>
                <button type="button" class="crop-control-btn" id="flipH">⇆ Flip</button>
                <button type="button" class="crop-control-btn" id="resetCrop">Reset</button>
            </div>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" id="cancelCrop">Cancel</button>
                <button type="button" class="crop-apply-btn" id="cropConfirm">Apply Crop</button>
            </div>
        </div>
    </div>
</div>

<!-- Image Compression Modal -->
<div id="compressModal" class="compress-modal">
    <div class="compress-modal-content">
        <div class="compress-header">
            <h2>⚠️ Large Image Detected</h2>
            <button type="button" id="closeCompressModal" class="compress-close-btn">&times;</button>
        </div>
        <div class="compress-body">
            <div class="file-size-info">
                <p>Your image is <span id="originalFileSize" class="size-value">0 MB</span> which exceeds the 20MB
                    limit.</p>
                <p style="margin: 0;">Compress the image to reduce file size before uploading.</p>
            </div>

            <div class="compress-quality">
                <label>Compression Quality</label>
                <div style="display: flex; align-items: center;">
                    <input type="range" id="qualitySlider" class="quality-slider" min="10" max="100" value="70">
                    <span id="qualityValue" class="quality-value">70%</span>
                </div>
                <span class="input-hint">Lower quality = smaller file size. 70% is recommended.</span>
            </div>

            <div class="compress-preview">
                <span>Estimated new size:</span>
                <span id="estimatedSize" class="new-size">~5 MB</span>
            </div>

            <div class="compress-progress" id="compressProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p class="progress-text" id="progressText">Compressing...</p>
            </div>
        </div>
        <div class="compress-footer">
            <button type="button" class="btn btn-secondary" id="skipCompress">Cancel</button>
            <button type="button" class="btn btn-primary" id="compressImage">Compress Image</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Elements
        const fileInput = document.getElementById('image-input');
        const uploadArea = document.getElementById('upload-area');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const uploadLabel = document.querySelector('.upload-label');
        const btnRemoveImage = document.getElementById('btn-remove-image');
        const cropModal = document.getElementById('cropModal');
        const cropImage = document.getElementById('cropImage');

        let cropper = null;
        let originalFile = null;
        let scaleX = 1;
        let scaleY = 1;
        let isInternalChange = false;
        let pendingFile = null;

        // Compression Modal Elements
        const compressModal = document.getElementById('compressModal');
        const originalFileSizeEl = document.getElementById('originalFileSize');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const estimatedSizeEl = document.getElementById('estimatedSize');
        const compressProgress = document.getElementById('compressProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB in bytes

        // Format file size for display
        function formatFileSize(bytes) {
            if (bytes >= 1024 * 1024) {
                return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
            } else if (bytes >= 1024) {
                return (bytes / 1024).toFixed(1) + ' KB';
            }
            return bytes + ' bytes';
        }

        // Update estimated size based on quality
        function updateEstimatedSize() {
            if (!pendingFile) return;
            const quality = qualitySlider.value / 100;
            qualityValue.textContent = qualitySlider.value + '%';
            // Rough estimation: compressed size ~ original * quality^2
            const estimatedBytes = pendingFile.size * Math.pow(quality, 1.5);
            estimatedSizeEl.textContent = '~' + formatFileSize(estimatedBytes);
        }

        // Compress image using canvas (using createObjectURL for memory efficiency)
        function compressImage(file, quality) {
            return new Promise((resolve, reject) => {
                console.log('Starting compression. File:', file.name, 'Size:', formatFileSize(file.size), 'Quality:', quality);

                const img = new Image();
                const objectUrl = URL.createObjectURL(file);

                // Add timeout to catch hangs
                const timeout = setTimeout(() => {
                    URL.revokeObjectURL(objectUrl);
                    console.error('Image load timeout');
                    reject(new Error('Image load timeout'));
                }, 60000); // 60 second timeout for very large files

                img.onload = () => {
                    clearTimeout(timeout);
                    console.log('Image loaded. Original dimensions:', img.width, 'x', img.height);

                    try {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // More aggressive resize for very large images
                        const maxDimension = 1600;
                        if (width > maxDimension || height > maxDimension) {
                            if (width > height) {
                                height = Math.round((height / width) * maxDimension);
                                width = maxDimension;
                            } else {
                                width = Math.round((width / height) * maxDimension);
                                height = maxDimension;
                            }
                        }

                        console.log('Resized dimensions:', width, 'x', height);

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        if (!ctx) {
                            URL.revokeObjectURL(objectUrl);
                            reject(new Error('Could not get canvas context'));
                            return;
                        }

                        ctx.drawImage(img, 0, 0, width, height);
                        console.log('Image drawn to canvas. Converting to blob...');

                        canvas.toBlob((blob) => {
                            URL.revokeObjectURL(objectUrl);

                            if (blob) {
                                console.log('Blob created. Size:', formatFileSize(blob.size));
                                const compressedFile = new File([blob], file.name.replace(/\.[^/.]+$/, '.jpg'), {
                                    type: 'image/jpeg',
                                    lastModified: Date.now(),
                                });
                                console.log('Compression complete:', formatFileSize(compressedFile.size));
                                resolve(compressedFile);
                            } else {
                                console.error('toBlob returned null');
                                reject(new Error('Failed to create compressed image'));
                            }
                        }, 'image/jpeg', quality);
                    } catch (error) {
                        URL.revokeObjectURL(objectUrl);
                        console.error('Canvas error:', error);
                        reject(error);
                    }
                };

                img.onerror = (error) => {
                    clearTimeout(timeout);
                    URL.revokeObjectURL(objectUrl);
                    console.error('Image load error:', error);
                    reject(new Error('Failed to load image'));
                };

                img.src = objectUrl;
            });
        }

        // Process file (show compression modal if needed or go to crop)
        function processFile(file) {
            console.log('Processing file:', file.name, 'Size:', file.size, 'Max:', MAX_FILE_SIZE);
            console.log('File size in MB:', (file.size / (1024 * 1024)).toFixed(2));
            console.log('File type:', file.type);

            // Check for supported image formats (browsers can't handle TIF, HEIC, RAW, etc.)
            const supportedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif', 'image/bmp'];
            const fileExt = file.name.toLowerCase().split('.').pop();
            const unsupportedExts = ['tif', 'tiff', 'heic', 'heif', 'raw', 'cr2', 'nef', 'arw', 'dng'];

            if (unsupportedExts.includes(fileExt) || (!supportedTypes.includes(file.type) && file.type !== '')) {
                alert('Unsupported file format: .' + fileExt + '\n\nPlease use JPG, PNG, WebP, or GIF format.\n\nTIP: Convert your ' + fileExt.toUpperCase() + ' file to JPG before uploading.');
                fileInput.value = '';
                return;
            }

            if (file.size >= MAX_FILE_SIZE) {
                // Show compression modal
                console.log('File exceeds 20MB, showing compression modal');

                if (!compressModal) {
                    console.error('Compress modal element not found!');
                    alert('Large file detected (' + formatFileSize(file.size) + '). Proceeding with original file.');
                    proceedToCrop(file);
                    return;
                }

                pendingFile = file;
                originalFileSizeEl.textContent = formatFileSize(file.size);
                updateEstimatedSize();
                compressModal.style.display = 'flex';
                console.log('Compress modal display set to:', compressModal.style.display);
            } else {
                // File is under 20MB, proceed directly to crop
                console.log('File under 20MB (' + formatFileSize(file.size) + '), proceeding to crop');
                proceedToCrop(file);
            }
        }

        // Proceed to crop modal
        function proceedToCrop(file) {
            originalFile = file;
            const reader = new FileReader();

            reader.onload = (event) => {
                cropImage.src = event.target.result;
                cropModal.style.display = 'flex';

                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(cropImage, {
                    aspectRatio: NaN,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            };

            reader.readAsDataURL(file);
        }

        // Quality slider event
        qualitySlider.addEventListener('input', updateEstimatedSize);

        // Compress button
        document.getElementById('compressImage').addEventListener('click', async function () {
            if (!pendingFile) return;

            const quality = qualitySlider.value / 100;

            // Check estimated size BEFORE compression
            const estimatedBytes = pendingFile.size * Math.pow(quality, 1.5);
            if (estimatedBytes >= MAX_FILE_SIZE) {
                // Show error in modal UI
                compressProgress.style.display = 'block';
                progressFill.style.width = '100%';
                progressFill.style.background = '#f44336';
                progressText.innerHTML = '<strong style="color:#c62828;">❌ Estimated size (' + formatFileSize(estimatedBytes) + ') is still over 20MB!</strong><br>Please lower the quality slider.';

                // Reset after 3 seconds
                setTimeout(() => {
                    progressFill.style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
                    compressProgress.style.display = 'none';
                }, 3000);
                return;
            }

            // Show progress
            compressProgress.style.display = 'block';
            progressFill.style.width = '0%';
            progressText.textContent = 'Compressing...';

            try {
                // Animate progress
                progressFill.style.width = '30%';
                await new Promise(r => setTimeout(r, 100));

                const compressedFile = await compressImage(pendingFile, quality);

                progressFill.style.width = '100%';

                // Check if compressed file is still too large
                if (compressedFile.size >= MAX_FILE_SIZE) {
                    progressFill.style.background = '#f44336';
                    progressText.textContent = 'Error: Compressed file is still ' + formatFileSize(compressedFile.size) + ' (must be under 20MB)';
                    alert('Compression failed!\n\nCompressed size: ' + formatFileSize(compressedFile.size) + '\nRequired: Under 20MB\n\nPlease lower the quality slider or use a smaller original image.');

                    // Reset progress bar color for next attempt
                    setTimeout(() => {
                        progressFill.style.background = 'linear-gradient(90deg, #4caf50, #8bc34a)';
                        compressProgress.style.display = 'none';
                    }, 2000);
                    return;
                }

                progressText.textContent = 'Done! Compressed to ' + formatFileSize(compressedFile.size);

                await new Promise(r => setTimeout(r, 500));

                // Close modal and proceed to crop
                compressModal.style.display = 'none';
                compressProgress.style.display = 'none';
                proceedToCrop(compressedFile);

            } catch (error) {
                console.error('Compression error:', error);
                progressText.textContent = 'Error compressing image. Please try again.';
                progressFill.style.background = '#f44336';
            }

            pendingFile = null;
        });

        // Skip compression button - show error, don't allow uncompressed large files
        document.getElementById('skipCompress').addEventListener('click', function () {
            if (pendingFile) {
                // Show error - file is too large
                alert('Error: File is too large (' + formatFileSize(pendingFile.size) + ').\n\nPlease compress the image or upload a smaller file (under 20MB).');
                compressModal.style.display = 'none';
                pendingFile = null;
                fileInput.value = '';
            }
        });

        // Close compression modal
        document.getElementById('closeCompressModal').addEventListener('click', function () {
            compressModal.style.display = 'none';
            pendingFile = null;
            fileInput.value = '';
        });

        // File Selection Handler
        fileInput.addEventListener('change', function (e) {
            if (isInternalChange) {
                isInternalChange = false;
                return;
            }

            if (this.files && this.files[0]) {
                processFile(this.files[0]);
            }
        });

        // Remove Image
        btnRemoveImage.addEventListener('click', function (e) {
            e.preventDefault();
            fileInput.value = '';
            imagePreview.style.display = 'none';
            uploadArea.style.display = 'block';
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files && e.dataTransfer.files[0]) {
                fileInput.files = e.dataTransfer.files;
                fileInput.dispatchEvent(new Event('change'));
            }
        });

        // Cropper Controls
        document.getElementById('zoomIn').addEventListener('click', () => cropper && cropper.zoom(0.1));
        document.getElementById('zoomOut').addEventListener('click', () => cropper && cropper.zoom(-0.1));
        document.getElementById('rotateLeft').addEventListener('click', () => cropper && cropper.rotate(-45));
        document.getElementById('rotateRight').addEventListener('click', () => cropper && cropper.rotate(45));
        document.getElementById('flipH').addEventListener('click', () => {
            scaleX = scaleX === 1 ? -1 : 1;
            if (cropper) cropper.scaleX(scaleX);
        });
        document.getElementById('resetCrop').addEventListener('click', () => {
            if (cropper) {
                cropper.reset();
                scaleX = 1;
                scaleY = 1;
            }
        });

        // Close Modal Handlers
        function closeCropModal() {
            cropModal.style.display = 'none';
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            if (imagePreview.style.display === 'none') {
                fileInput.value = '';
            }
        }

        document.getElementById('closeCropModal').addEventListener('click', closeCropModal);
        document.getElementById('cancelCrop').addEventListener('click', closeCropModal);

        // Apply Crop
        document.getElementById('cropConfirm').addEventListener('click', function (e) {
            e.preventDefault();
            e.stopPropagation();

            if (!cropper) {
                closeCropModal();
                return;
            }

            try {
                const canvas = cropper.getCroppedCanvas({
                    maxWidth: 2048,
                    maxHeight: 2048,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high',
                });

                if (!canvas) {
                    closeCropModal();
                    return;
                }

                canvas.toBlob(function (blob) {
                    if (!blob) {
                        closeCropModal();
                        return;
                    }

                    const fileName = originalFile ? originalFile.name : 'cropped-image.jpg';
                    const fileType = originalFile ? originalFile.type : 'image/jpeg';

                    const croppedFile = new File([blob], fileName, {
                        type: fileType,
                        lastModified: Date.now(),
                    });

                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(croppedFile);

                    isInternalChange = true;
                    fileInput.files = dataTransfer.files;

                    previewImg.src = canvas.toDataURL(fileType);
                    imagePreview.style.display = 'flex';
                    uploadArea.style.display = 'none';

                    cropModal.style.display = 'none';
                    if (cropper) {
                        cropper.destroy();
                        cropper = null;
                    }
                }, originalFile ? originalFile.type : 'image/jpeg');
            } catch (error) {
                console.error('Error during crop:', error);
                alert('Error cropping image. Please try again.');
                closeCropModal();
            }
        });

        window.addEventListener('click', function (e) {
            if (e.target === cropModal) closeCropModal();
        });

        // Color picker sync with auto color naming
        const colorPicker = document.getElementById('color_hex');
        const colorHexDisplay = document.getElementById('color_hex_display');
        const colorNameInput = document.getElementById('color');
        const colorPreview = document.getElementById('color-preview');

        function hexToColorName(hex) {
            hex = hex.toUpperCase().replace('#', '');

            const colorNames = {
                'FF0000': 'Red', 'DC143C': 'Crimson', 'B22222': 'Firebrick',
                'FFC0CB': 'Pink', 'FFB6C1': 'Light Pink', 'FF69B4': 'Hot Pink',
                'FFA500': 'Orange', 'FF8C00': 'Dark Orange', 'FFD700': 'Gold',
                'FFFF00': 'Yellow', 'FFFFE0': 'Light Yellow',
                '00FF00': 'Lime', '008000': 'Green', '006400': 'Dark Green', '90EE90': 'Light Green',
                '0000FF': 'Blue', '00008B': 'Dark Blue', '000080': 'Navy', '87CEEB': 'Sky Blue',
                '800080': 'Purple', '8B008B': 'Dark Magenta', 'EE82EE': 'Violet',
                'A0522D': 'Sienna', 'D2691E': 'Chocolate', '8B4513': 'Saddle Brown',
                'FFFFFF': 'White', 'F5F5F5': 'White Smoke', 'FAEBD7': 'Antique White',
                '000000': 'Black', '696969': 'Dim Gray', '808080': 'Gray', 'C0C0C0': 'Silver',
                'F5F5DC': 'Beige', 'DAD3C2': 'Sand', 'D2B48C': 'Tan',
            };

            if (colorNames[hex]) {
                return colorNames[hex];
            }

            const r1 = parseInt(hex.substr(0, 2), 16);
            const g1 = parseInt(hex.substr(2, 2), 16);
            const b1 = parseInt(hex.substr(4, 2), 16);

            let closestName = 'Custom Color';
            let minDistance = Infinity;

            for (const [hexCode, name] of Object.entries(colorNames)) {
                const r2 = parseInt(hexCode.substr(0, 2), 16);
                const g2 = parseInt(hexCode.substr(2, 2), 16);
                const b2 = parseInt(hexCode.substr(4, 2), 16);

                const distance = Math.sqrt(
                    Math.pow(r1 - r2, 2) +
                    Math.pow(g1 - g2, 2) +
                    Math.pow(b1 - b2, 2)
                );

                if (distance < minDistance) {
                    minDistance = distance;
                    closestName = name;
                }
            }

            return closestName;
        }

        function updateColorFromPicker() {
            const hexValue = colorPicker.value.toUpperCase();
            colorHexDisplay.value = hexValue;
            colorPreview.style.background = hexValue;

            const currentName = colorNameInput.value.trim();
            const newName = hexToColorName(hexValue);

            if (!currentName || colorNameInput.dataset.autoGenerated === 'true') {
                colorNameInput.value = newName;
                colorNameInput.dataset.autoGenerated = 'true';
            }
        }

        colorPicker.addEventListener('input', updateColorFromPicker);
        colorPicker.addEventListener('change', updateColorFromPicker);

        colorHexDisplay.addEventListener('change', (e) => {
            let value = e.target.value.trim();
            if (!value.startsWith('#')) value = '#' + value;

            if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
                colorPicker.value = value;
                colorPreview.style.background = value;

                const currentName = colorNameInput.value.trim();
                const newName = hexToColorName(value);

                if (!currentName || colorNameInput.dataset.autoGenerated === 'true') {
                    colorNameInput.value = newName;
                    colorNameInput.dataset.autoGenerated = 'true';
                }
            }
        });

        colorNameInput.addEventListener('input', function () {
            this.dataset.autoGenerated = 'false';
        });

        updateColorFromPicker();

        // AI Image Analysis
        const analyzeBtn = document.getElementById('analyze-image-btn');
        const aiSection = document.getElementById('ai-analysis-section');
        const aiLoading = document.getElementById('ai-loading');
        const aiResults = document.getElementById('ai-results');
        const aiApplyAll = document.getElementById('ai-apply-all');
        const aiApplyBasic = document.getElementById('ai-apply-basic');
        const aiApplyColor = document.getElementById('ai-apply-color');

        let currentAnalysis = null;

        analyzeBtn.addEventListener('click', async function () {
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Please select an image first');
                return;
            }

            const file = fileInput.files[0];

            aiSection.style.display = 'block';
            aiLoading.style.display = 'block';
            aiResults.style.display = 'none';
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = 'Analyzing...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch('/wardrobe/api/analyze-image/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });

                const data = await response.json();

                if (data.success) {
                    currentAnalysis = data.analysis;
                    displayAnalysisResults(data.analysis);
                } else {
                    throw new Error(data.error || 'Analysis failed');
                }

            } catch (error) {
                console.error('AI Analysis error:', error);
                alert('Failed to analyze image: ' + error.message);
                aiSection.style.display = 'none';
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'Analyze with AI';
            }
        });

        function displayAnalysisResults(analysis) {
            aiLoading.style.display = 'none';
            aiResults.style.display = 'block';

            document.getElementById('ai-item-type').textContent = analysis.item_type || 'Unknown';
            document.getElementById('ai-confidence').textContent = Math.round((analysis.confidence || 0) * 100);
            document.getElementById('ai-style').textContent = analysis.style || 'Unknown';
            document.getElementById('ai-material').textContent = analysis.material || 'Unknown';
            document.getElementById('ai-description').textContent = analysis.description || 'No description available';
        }

        // Category detection mapping
        function detectCategoryFromItemType(itemType) {
            const itemTypeLower = itemType.toLowerCase();

            // Tops
            const tops = ['shirt', 't-shirt', 'tshirt', 'blouse', 'top', 'sweater', 'sweatshirt',
                'hoodie', 'cardigan', 'pullover', 'polo', 'tank', 'vest', 'tee', 'tunic',
                'crop top', 'henley', 'jersey'];

            // Bottoms
            const bottoms = ['pants', 'trousers', 'jeans', 'shorts', 'skirt', 'leggings',
                'joggers', 'chinos', 'slacks', 'culottes', 'capris', 'bermuda'];

            // Dresses
            const dresses = ['dress', 'gown', 'maxi', 'midi', 'mini dress', 'sundress',
                'romper', 'jumpsuit', 'playsuit'];

            // Outerwear
            const outerwear = ['jacket', 'coat', 'blazer', 'parka', 'windbreaker', 'bomber',
                'trench', 'overcoat', 'peacoat', 'denim jacket', 'leather jacket',
                'rain coat', 'fleece', 'anorak'];

            // Shoes
            const shoes = ['shoes', 'sneakers', 'boots', 'sandals', 'heels', 'flats',
                'loafers', 'oxfords', 'pumps', 'mules', 'slip-ons', 'trainers',
                'running shoes', 'athletic shoes', 'dress shoes'];

            // Accessories
            const accessories = ['hat', 'cap', 'beanie', 'scarf', 'gloves', 'belt', 'tie',
                'bow tie', 'sunglasses', 'glasses', 'watch', 'jewelry',
                'necklace', 'bracelet', 'ring', 'earrings', 'bag', 'purse',
                'handbag', 'backpack', 'wallet', 'clutch'];

            // Underwear/Intimates
            const underwear = ['underwear', 'boxers', 'briefs', 'bra', 'panties', 'socks',
                'stockings', 'tights', 'lingerie', 'shapewear'];

            // Swimwear
            const swimwear = ['swimsuit', 'bikini', 'swim trunks', 'swimwear', 'bathing suit',
                'one-piece', 'swim shorts'];

            // Activewear
            const activewear = ['sportswear', 'activewear', 'yoga pants', 'sports bra',
                'athletic wear', 'gym clothes', 'workout'];

            // Check each category - returns names matching database categories
            for (const word of tops) {
                if (itemTypeLower.includes(word)) return 'Top';
            }
            for (const word of bottoms) {
                if (itemTypeLower.includes(word)) return 'Bottom';
            }
            for (const word of dresses) {
                if (itemTypeLower.includes(word)) return 'Dress';
            }
            for (const word of outerwear) {
                if (itemTypeLower.includes(word)) return 'Jacket';
            }
            for (const word of shoes) {
                if (itemTypeLower.includes(word)) return 'Shoe';
            }
            for (const word of accessories) {
                // Check specific accessory types that have their own categories
                if (itemTypeLower.includes('bag') || itemTypeLower.includes('purse') ||
                    itemTypeLower.includes('handbag') || itemTypeLower.includes('backpack')) return 'Bag';
                if (itemTypeLower.includes('hat') || itemTypeLower.includes('cap') ||
                    itemTypeLower.includes('beanie')) return 'Hat';
                if (itemTypeLower.includes('scarf')) return 'Scarf';
                if (itemTypeLower.includes('belt')) return 'Belt';
                return 'Bag'; // Default accessory category
            }
            for (const word of underwear) {
                if (itemTypeLower.includes(word)) return 'Bottom'; // Map to closest
            }
            for (const word of swimwear) {
                if (itemTypeLower.includes(word)) return 'Sport';
            }
            for (const word of activewear) {
                if (itemTypeLower.includes(word)) return 'Sport';
            }

            return null; // No match found
        }

        aiApplyAll.addEventListener('click', () => applyAISuggestions('all'));
        aiApplyBasic.addEventListener('click', () => applyAISuggestions('basic'));
        aiApplyColor.addEventListener('click', () => applyAISuggestions('color'));

        // Extract color from AI description (more reliable than pixel analysis for product photos)
        function extractColorFromDescription(description) {
            if (!description) return null;
            const descLower = description.toLowerCase();

            // Common colors to look for in description
            const colors = ['black', 'white', 'grey', 'gray', 'navy', 'blue', 'red', 'green',
                'yellow', 'orange', 'purple', 'pink', 'brown', 'beige', 'tan',
                'cream', 'burgundy', 'maroon', 'olive', 'teal', 'coral', 'gold',
                'silver', 'charcoal', 'khaki', 'denim', 'indigo'];

            for (const color of colors) {
                if (descLower.includes(color)) {
                    // Capitalize first letter
                    return color.charAt(0).toUpperCase() + color.slice(1);
                }
            }
            return null;
        }

        function applyAISuggestions(type) {
            if (!currentAnalysis) return;

            if (type === 'all' || type === 'basic') {
                // Try to get color from description first (more accurate for product photos)
                const descriptionColor = extractColorFromDescription(currentAnalysis.description);
                const bestColor = descriptionColor || currentAnalysis.color || '';

                if (currentAnalysis.item_type) {
                    const colorPart = bestColor ? `${bestColor} ` : '';
                    document.getElementById('name').value = `${colorPart}${currentAnalysis.item_type}`;
                }
                if (currentAnalysis.description) document.getElementById('description').value = currentAnalysis.description;
                if (currentAnalysis.material) document.getElementById('material').value = currentAnalysis.material;
                if (currentAnalysis.brand_guess) document.getElementById('brand').value = currentAnalysis.brand_guess;
                if (currentAnalysis.pattern) document.getElementById('pattern').value = currentAnalysis.pattern;

                // Auto-detect category from item type
                if (currentAnalysis.item_type) {
                    const detectedCategory = detectCategoryFromItemType(currentAnalysis.item_type);
                    if (detectedCategory) {
                        const categorySelect = document.getElementById('category');
                        // Find matching option by text content
                        for (let option of categorySelect.options) {
                            if (option.text.toLowerCase().includes(detectedCategory.toLowerCase())) {
                                categorySelect.value = option.value;
                                break;
                            }
                        }
                    }
                }

                if (currentAnalysis.occasions && currentAnalysis.occasions.length > 0) {
                    document.querySelectorAll('input[name="occasions"]').forEach(cb => {
                        cb.checked = currentAnalysis.occasions.includes(cb.value);
                    });
                }
                if (currentAnalysis.seasons && currentAnalysis.seasons.length > 0) {
                    document.querySelectorAll('input[name="seasons"]').forEach(cb => {
                        cb.checked = currentAnalysis.seasons.includes(cb.value);
                    });
                }
                if (currentAnalysis.tags && currentAnalysis.tags.length > 0) {
                    document.getElementById('tags').value = currentAnalysis.tags.join(', ');
                }
            }

            if (type === 'all' || type === 'color') {
                // Use description-extracted color if available (more accurate for product photos)
                const descriptionColor = extractColorFromDescription(currentAnalysis.description);
                const bestColor = descriptionColor || currentAnalysis.color;

                if (bestColor) document.getElementById('color').value = bestColor;

                // For hex, use the analyzed hex or map common colors to hex
                if (currentAnalysis.color_hex && !descriptionColor) {
                    document.getElementById('color_hex').value = currentAnalysis.color_hex;
                    document.getElementById('color_hex_display').value = currentAnalysis.color_hex.toUpperCase();
                } else if (descriptionColor) {
                    // Map description color to approximate hex
                    const colorHexMap = {
                        'Black': '#000000', 'White': '#FFFFFF', 'Grey': '#808080', 'Gray': '#808080',
                        'Navy': '#000080', 'Blue': '#0000FF', 'Red': '#FF0000', 'Green': '#008000',
                        'Yellow': '#FFFF00', 'Orange': '#FFA500', 'Purple': '#800080', 'Pink': '#FFC0CB',
                        'Brown': '#8B4513', 'Beige': '#F5F5DC', 'Tan': '#D2B48C', 'Cream': '#FFFDD0',
                        'Burgundy': '#800020', 'Maroon': '#800000', 'Olive': '#808000', 'Teal': '#008080',
                        'Coral': '#FF7F50', 'Gold': '#FFD700', 'Silver': '#C0C0C0', 'Charcoal': '#36454F',
                        'Khaki': '#F0E68C', 'Denim': '#1560BD', 'Indigo': '#4B0082'
                    };
                    const hex = colorHexMap[descriptionColor] || currentAnalysis.color_hex || '#808080';
                    document.getElementById('color_hex').value = hex;
                    document.getElementById('color_hex_display').value = hex.toUpperCase();
                }
            }

            const message = type === 'all' ? 'All AI suggestions applied!' :
                type === 'basic' ? 'Basic information applied!' : 'Color information applied!';

            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #2c2c2c; color: #f4e9cf; padding: 12px 20px; z-index: 1000; font-family: Inter, sans-serif;';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }
    });
</script>
{% endblock %}