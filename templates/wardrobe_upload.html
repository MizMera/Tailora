{% extends 'base.html' %}
{% load static %}

{% block title %}Add an item - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/wardrobe.css' %}">
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<style>
    .crop-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        overflow: auto;
    }

    .crop-modal-content {
        position: relative;
        background-color: #fff;
        margin: 2% auto;
        padding: 0;
        width: 90%;
        max-width: 900px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .crop-header {
        padding: 20px 24px;
        background: #f8f9fa;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 8px 8px 0 0;
    }

    .crop-header h2 {
        font-family: 'Inter', sans-serif;
        font-size: 18px;
        font-weight: 600;
        color: #2c2c2c;
        margin: 0;
    }

    .crop-body {
        padding: 24px;
        max-height: 70vh;
        overflow: hidden;
    }

    .crop-container {
        max-height: 60vh;
        overflow: hidden;
    }

    .crop-footer {
        padding: 20px 24px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 0 0 8px 8px;
    }

    .crop-controls {
        display: flex;
        gap: 8px;
    }

    .crop-control-btn {
        padding: 8px 16px;
        background: #fff;
        border: 1px solid #d9d9d9;
        border-radius: 4px;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #2c2c2c;
        transition: all 0.2s;
    }

    .crop-control-btn:hover {
        background: #f5f5f5;
        border-color: #bbb;
    }

    .crop-control-btn.active {
        background: #667eea;
        color: #fff;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block container_class %}page-reveal{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div>
            <h1 class="page-title">Add an item</h1>
            <p style="font-family: 'Inter', sans-serif; font-size: 16px; color: #757575; margin-top: 8px;">{{
                remaining_slots }} / {{ max_items }} slots available</p>
        </div>
        <div>
            <a href="{% url 'wardrobe_gallery' %}" class="btn btn-secondary">Back</a>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
{% for message in messages %}
<div class="message {% if message.tags == 'error' %}message-error{% else %}message-success{% endif %}"
    style="margin: 0; border-left: none; border-bottom: 1px solid #e0e0e0; padding: 16px 40px;">
    {{ message }}
</div>
{% endfor %}
{% endif %}

<!-- Upload Form -->
<div style="background: #ffffff; padding: 40px;">
    <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}

        <div class="settings-section">
            <h3 class="section-title">Item photo</h3>

            <div class="image-upload-area"
                style="padding: 40px; background: #fafafa; border: 2px dashed #d9d9d9; text-align: center; cursor: pointer;">
                <input type="file" id="image-input" name="image" accept="image/*" required style="display: none;">
                <label for="image-input" class="upload-label" style="cursor: pointer; display: block;">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#757575"
                        style="margin: 0 auto 16px;">
                        <rect x="3" y="3" width="18" height="18" stroke-width="2" />
                        <circle cx="8.5" cy="8.5" r="1.5" fill="#757575" />
                        <path d="m21 15-5-5L5 21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p
                        style="font-family: 'Inter', sans-serif; font-size: 16px; font-weight: 600; color: #252320; margin-bottom: 4px;">
                        Click to add an image</p>
                    <p style="font-family: 'Inter', sans-serif; font-size: 14px; color: #757575;">JPG or PNG (max 5 MB)
                    </p>
                </label>
                <div id="image-preview" class="image-preview" style="display: none; margin-top: 24px;">
                    <img id="preview-img" src="" alt="Preview"
                        style="max-width: 300px; max-height: 300px; border: 1px solid #d9d9d9;">
                    <div style="margin-top: 16px; display: flex; gap: 12px; align-items: center;">
                        <button type="button" id="analyze-image-btn" class="btn btn-primary"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                            Analyze with AI
                        </button>
                        <button type="button" class="btn btn-secondary btn-remove-image">Remove</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Section -->
        <div class="settings-section" id="ai-analysis-section" style="display: none;">
            <h3 class="section-title">AI Analysis</h3>
            <div id="ai-analysis-results"
                style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 16px;">
                <div id="ai-loading" style="text-align: center; display: none;">
                    <div
                        style="display: inline-block; width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px;">
                    </div>
                    Analyzing image with AI...
                </div>
                <div id="ai-results" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <strong>Detected:</strong> <span id="ai-item-type"></span>
                        </div>
                        <div>
                            <strong>Confidence:</strong> <span id="ai-confidence"></span>%
                        </div>
                        <div>
                            <strong>Style:</strong> <span id="ai-style"></span>
                        </div>
                        <div>
                            <strong>Material:</strong> <span id="ai-material"></span>
                        </div>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <strong>Description:</strong> <span id="ai-description"></span>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button type="button" id="ai-apply-all" class="btn btn-primary"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">Apply
                            All Suggestions</button>
                        <button type="button" id="ai-apply-basic" class="btn btn-secondary">Apply Basic Info</button>
                        <button type="button" id="ai-apply-color" class="btn btn-secondary">Apply Color</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Basic information</h3>

            <div class="form-grid">
                <div class="input-field">
                    <label for="name" class="input-label">Item name <span style="color: #c62828;">*</span></label>
                    <input type="text" id="name" name="name" placeholder="e.g., Navy blue T-shirt" required
                        class="input-control">
                </div>

                <div class="input-field">
                    <label for="category" class="input-label">Category</label>
                    <select id="category" name="category" class="input-control">
                        <option value="">Select a category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">{{ category.icon }} {{ category.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-grid-full">
                <div class="input-field">
                    <label for="description" class="input-label">Description</label>
                    <textarea id="description" name="description" placeholder="Describe this item..." rows="3"
                        class="input-control"></textarea>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Color</h3>

            <div class="form-grid">
                <div class="input-field">
                    <label for="color" class="input-label">Color <span style="color: #c62828;">*</span></label>
                    <input type="text" id="color" name="color" placeholder="e.g., Navy blue" required
                        class="input-control">
                </div>

                <div class="input-field">
                    <label for="color_hex" class="input-label">Hex color code</label>
                    <div style="display: flex; gap: 12px;">
                        <input type="color" id="color_hex" class="color-picker" name="color_hex" value="#DAD3C2"
                            style="width: 60px; height: 44px; border: 1px solid #d9d9d9; cursor: pointer;">
                        <input type="text" id="color_hex_display" class="color-hex-display" name="color_hex_display"
                            placeholder="#RRGGBB" class="input-control" readonly style="flex: 1;">
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Additional details</h3>

            <div class="form-grid">
                <div class="input-field">
                    <label for="brand" class="input-label">Brand</label>
                    <input type="text" id="brand" name="brand" placeholder="e.g., Nike, Zara..." class="input-control">
                </div>

                <div class="input-field">
                    <label for="material" class="input-label">Material</label>
                    <input type="text" id="material" name="material" placeholder="e.g., 100% Cotton"
                        class="input-control">
                </div>

                <div class="input-field">
                    <label for="pattern" class="input-label">Pattern</label>
                    <select id="pattern" name="pattern" class="input-control">
                        <option value="">None</option>
                        <option value="solid">Solid</option>
                        <option value="striped">Striped</option>
                        <option value="floral">Floral</option>
                        <option value="plaid">Plaid</option>
                        <option value="polka_dot">Polka dot</option>
                        <option value="geometric">Geometric</option>
                        <option value="animal">Animal</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="input-field">
                    <label for="condition" class="input-label">Condition</label>
                    <select id="condition" name="condition" class="input-control">
                        <option value="good">Good</option>
                        <option value="new">New</option>
                        <option value="excellent">Excellent</option>
                        <option value="fair">Fair</option>
                        <option value="worn">Worn</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Seasons and occasions</h3>

            <div class="form-grid-full">
                <div class="input-field">
                    <label class="input-label">Seasons</label>
                    <div class="checkbox-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="spring">
                            <span>Spring</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="summer">
                            <span>Summer</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="fall">
                            <span>Fall</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="winter">
                            <span>Winter</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="seasons" value="all_seasons">
                            <span>All seasons</span>
                        </label>
                    </div>
                </div>

                <div class="input-field">
                    <label class="input-label">Occasions</label>
                    <div class="checkbox-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="casual">
                            <span>Casual</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="formal">
                            <span>Formal</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="sport">
                            <span>Sport</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="party">
                            <span>Party</span>
                        </label>
                        <label class="checkbox-card">
                            <input type="checkbox" name="occasions" value="work">
                            <span>Work</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Purchase information</h3>

            <div class="form-grid">
                <div class="input-field">
                    <label for="purchase_date" class="input-label">Purchase date</label>
                    <input type="date" id="purchase_date" name="purchase_date" class="input-control">
                </div>

                <div class="input-field">
                    <label for="purchase_price" class="input-label">Price (EUR)</label>
                    <input type="number" id="purchase_price" name="purchase_price" placeholder="0.00" step="0.01"
                        min="0" class="input-control">
                </div>

                <div class="input-field">
                    <label for="purchase_location" class="input-label">Purchase location</label>
                    <input type="text" id="purchase_location" name="purchase_location"
                        placeholder="e.g., Zara, H&M, Thrifted..." class="input-control">
                </div>

                <div class="input-field">
                    <label
                        style="display: flex; align-items: center; gap: 8px; padding: 12px; background: #fafafa; border: 1px solid #d9d9d9; cursor: pointer; margin-top: 28px;">
                        <input type="checkbox" name="is_secondhand">
                        <span style="font-family: 'Inter', sans-serif; font-size: 14px; color: #252320;">Second-hand
                            item</span>
                    </label>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3 class="section-title">Tags</h3>

            <div class="form-grid-full">
                <div class="input-field">
                    <label for="tags" class="input-label">Tags (comma-separated)</label>
                    <input type="text" id="tags" name="tags" placeholder="e.g., comfy, summer, blue"
                        class="input-control">
                    <small class="input-hint">Add keywords to improve search</small>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{% url 'wardrobe_gallery' %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Add to my wardrobe</button>
        </div>
    </form>
</div>

<script>
    // Image preview
    const fileInput = document.getElementById('image-input');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const uploadLabel = document.querySelector('.upload-label');
    const btnRemoveImage = document.querySelector('.btn-remove-image');

    fileInput.addEventListener('change', function (e) {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (event) => {
                previewImg.src = event.target.result;
                imagePreview.style.display = 'flex';
                uploadLabel.style.display = 'none';
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    btnRemoveImage.addEventListener('click', function (e) {
        e.preventDefault();
        fileInput.value = '';
        imagePreview.style.display = 'none';
        uploadLabel.style.display = 'flex';
    });

    // Drag and drop
    uploadLabel.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadLabel.style.background = '#f5f5f5';
    });

    uploadLabel.addEventListener('dragleave', () => {
        uploadLabel.style.background = '';
    });

    uploadLabel.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadLabel.style.background = '';
        fileInput.files = e.dataTransfer.files;
        fileInput.dispatchEvent(new Event('change'));
    });

    // Color picker sync
    const colorPicker = document.querySelector('.color-picker');
    const colorHexDisplay = document.querySelector('.color-hex-display');

    colorPicker.addEventListener('change', (e) => {
        colorHexDisplay.value = e.target.value.toUpperCase();
    });

    colorHexDisplay.addEventListener('change', (e) => {
        if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
            colorPicker.value = e.target.value;
        }
    });

    // AI Image Analysis
    const analyzeBtn = document.getElementById('analyze-image-btn');
    const aiSection = document.getElementById('ai-analysis-section');
    const aiLoading = document.getElementById('ai-loading');
    const aiResults = document.getElementById('ai-results');
    const aiApplyAll = document.getElementById('ai-apply-all');
    const aiApplyBasic = document.getElementById('ai-apply-basic');
    const aiApplyColor = document.getElementById('ai-apply-color');

    let currentAnalysis = null;

    analyzeBtn.addEventListener('click', async function () {
        const fileInput = document.getElementById('image-input');
        if (!fileInput.files || !fileInput.files[0]) {
            alert('Please select an image first');
            return;
        }

        const file = fileInput.files[0];

        // Show loading state
        aiSection.style.display = 'block';
        aiLoading.style.display = 'block';
        aiResults.style.display = 'none';
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = 'Analyzing...';

        try {
            const formData = new FormData();
            formData.append('image', file);

            const response = await fetch('/wardrobe/api/analyze-image/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });

            const data = await response.json();

            if (data.success) {
                currentAnalysis = data.analysis;
                displayAnalysisResults(data.analysis, data.category_suggestions);
            } else {
                throw new Error(data.error || 'Analysis failed');
            }

        } catch (error) {
            console.error('AI Analysis error:', error);
            alert('Failed to analyze image: ' + error.message);
            aiSection.style.display = 'none';
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'Analyze with AI';
        }
    });

    function displayAnalysisResults(analysis, categorySuggestions) {
        aiLoading.style.display = 'none';
        aiResults.style.display = 'block';

        // Update display elements
        document.getElementById('ai-item-type').textContent = analysis.item_type || 'Unknown';
        document.getElementById('ai-confidence').textContent = Math.round((analysis.confidence || 0) * 100);
        document.getElementById('ai-style').textContent = analysis.style || 'Unknown';
        document.getElementById('ai-material').textContent = analysis.material || 'Unknown';
        document.getElementById('ai-description').textContent = analysis.description || 'No description available';
    }

    // Apply AI suggestions
    aiApplyAll.addEventListener('click', () => applyAISuggestions('all'));
    aiApplyBasic.addEventListener('click', () => applyAISuggestions('basic'));
    aiApplyColor.addEventListener('click', () => applyAISuggestions('color'));

    function applyAISuggestions(type) {
        if (!currentAnalysis) return;

        if (type === 'all' || type === 'basic') {
            // Apply name
            if (currentAnalysis.item_type && currentAnalysis.color) {
                document.getElementById('name').value = `${currentAnalysis.color} ${currentAnalysis.item_type}`;
            }

            // Apply description
            if (currentAnalysis.description) {
                document.getElementById('description').value = currentAnalysis.description;
            }

            // Apply material
            if (currentAnalysis.material) {
                document.getElementById('material').value = currentAnalysis.material;
            }

            // Apply brand guess
            if (currentAnalysis.brand_guess) {
                document.getElementById('brand').value = currentAnalysis.brand_guess;
            }

            // Apply pattern
            if (currentAnalysis.pattern) {
                document.getElementById('pattern').value = currentAnalysis.pattern;
            }

            // Apply occasions
            if (currentAnalysis.occasions && currentAnalysis.occasions.length > 0) {
                const occasionCheckboxes = document.querySelectorAll('input[name="occasions"]');
                occasionCheckboxes.forEach(cb => {
                    cb.checked = currentAnalysis.occasions.includes(cb.value);
                });
            }

            // Apply seasons
            if (currentAnalysis.seasons && currentAnalysis.seasons.length > 0) {
                const seasonCheckboxes = document.querySelectorAll('input[name="seasons"]');
                seasonCheckboxes.forEach(cb => {
                    cb.checked = currentAnalysis.seasons.includes(cb.value);
                });
            }

            // Apply tags
            if (currentAnalysis.tags && currentAnalysis.tags.length > 0) {
                document.getElementById('tags').value = currentAnalysis.tags.join(', ');
            }
        }

        if (type === 'all' || type === 'color') {
            // Apply color
            if (currentAnalysis.color) {
                document.getElementById('color').value = currentAnalysis.color;
            }

            // Apply color hex
            if (currentAnalysis.color_hex) {
                document.getElementById('color_hex').value = currentAnalysis.color_hex;
                document.getElementById('color_hex_display').value = currentAnalysis.color_hex.toUpperCase();
            }
        }

        // Show success message
        const message = type === 'all' ? 'All AI suggestions applied!' :
            type === 'basic' ? 'Basic information applied!' :
                'Color information applied!';
        showSuccessMessage(message);
    }

    function showSuccessMessage(message) {
        // Create temporary success message
        const successDiv = document.createElement('div');
        successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 1000;
                font-weight: 600;
            `;
        successDiv.textContent = message;
        document.body.appendChild(successDiv);

        setTimeout(() => {
            successDiv.remove();
        }, 3000);
    }

    // Fade in animation
    document.addEventListener('DOMContentLoaded', () => {
        document.body.style.opacity = '1';
    });
</script>

<!-- Cropper.js Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<!-- Image Cropper Modal -->
<div id="cropModal" class="crop-modal">
    <div class="crop-modal-content">
        <div class="crop-header">
            <h2>Crop Your Image</h2>
            <button type="button" id="closeCropModal" class="crop-control-btn"
                style="background: transparent; border: none; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;">&times;</button>
        </div>
        <div class="crop-body">
            <p
                style="font-family: 'Inter', sans-serif; font-size: 14px; color: #757575; margin-bottom: 16px; text-align: center;">
                Adjust the crop area to focus on your clothing item
            </p>
            <div class="crop-container">
                <img id="cropImage" src="" alt="Crop preview" style="max-width: 100%;">
            </div>
        </div>
        <div class="crop-footer">
            <div class="crop-controls">
                <button type="button" class="crop-control-btn" id="zoomIn" title="Zoom In">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="16" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>
                </button>
                <button type="button" class="crop-control-btn" id="zoomOut" title="Zoom Out">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="8" y1="12" x2="16" y2="12" />
                    </svg>
                </button>
                <button type="button" class="crop-control-btn" id="rotateLeft" title="Rotate Left">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
                        <path d="M3 3v5h5" />
                    </svg>
                </button>
                <button type="button" class="crop-control-btn" id="rotateRight" title="Rotate Right">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8" />
                        <path d="M21 3v5h-5" />
                    </svg>
                </button>
                <button type="button" class="crop-control-btn" id="flipH" title="Flip Horizontal">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 3v18" />
                        <path d="M8 7h8" />
                        <path d="M8 12h8" />
                        <path d="M8 17h8" />
                    </svg>
                </button>
                <button type="button" class="crop-control-btn" id="resetCrop" title="Reset">â†» Reset</button>
            </div>
            <div style="display: flex; gap: 12px;">
                <button type="button" class="btn btn-secondary" id="cancelCrop">Cancel</button>
                <button type="button" class="btn btn-primary" id="cropConfirm"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none;">
                    Apply Crop
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let cropper = null;
    let originalFile = null;
    let scaleX = 1;
    let scaleY = 1;

    // Open crop modal when image is selected
    const originalFileInput = document.getElementById('image-input');

    originalFileInput.addEventListener('change', function (e) {
        if (this.files && this.files[0]) {
            originalFile = this.files[0];
            const reader = new FileReader();

            reader.onload = (event) => {
                // Show crop modal
                const cropModal = document.getElementById('cropModal');
                const cropImage = document.getElementById('cropImage');

                cropImage.src = event.target.result;
                cropModal.style.display = 'block';

                // Initialize cropper
                if (cropper) {
                    cropper.destroy();
                }

                cropper = new Cropper(cropImage, {
                    aspectRatio: NaN, // Free aspect ratio
                    viewMode: 1,
                    autoCropArea: 0.8,
                    responsive: true,
                    guides: true,
                    center: true,
                    highlight: true,
                    cropBoxMovable: true,
                    cropBoxResizable: true,
                    toggleDragModeOnDblclick: false,
                });
            };

            reader.readAsDataURL(this.files[0]);
        }
    });

    // Crop controls
    document.getElementById('zoomIn').addEventListener('click', () => {
        if (cropper) cropper.zoom(0.1);
    });

    document.getElementById('zoomOut').addEventListener('click', () => {
        if (cropper) cropper.zoom(-0.1);
    });

    document.getElementById('rotateLeft').addEventListener('click', () => {
        if (cropper) cropper.rotate(-45);
    });

    document.getElementById('rotateRight').addEventListener('click', () => {
        if (cropper) cropper.rotate(45);
    });

    document.getElementById('flipH').addEventListener('click', () => {
        scaleX = scaleX === 1 ? -1 : 1;
        if (cropper) cropper.scaleX(scaleX);
    });

    document.getElementById('resetCrop').addEventListener('click', () => {
        if (cropper) {
            cropper.reset();
            scaleX = 1;
            scaleY = 1;
        }
    });

    // Close modal handlers
    document.getElementById('closeCropModal').addEventListener('click', closeCropModal);
    document.getElementById('cancelCrop').addEventListener('click', closeCropModal);

    function closeCropModal() {
        const cropModal = document.getElementById('cropModal');
        cropModal.style.display = 'none';
        if (cropper) {
            cropper.destroy();
            cropper = null;
        }
        // Reset file input
        originalFileInput.value = '';
    }

    // Apply crop
    document.getElementById('cropConfirm').addEventListener('click', () => {
        if (!cropper) return;

        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
            maxWidth: 2048,
            maxHeight: 2048,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high',
        });

        // Convert canvas to blob
        canvas.toBlob((blob) => {
            // Create new file from blob
            const croppedFile = new File([blob], originalFile.name, {
                type: originalFile.type,
                lastModified: Date.now(),
            });

            // Update file input with cropped image
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            originalFileInput.files = dataTransfer.files;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('preview-img');
                const imagePreview = document.getElementById('image-preview');
                const uploadLabel = document.querySelector('.upload-label');

                previewImg.src = e.target.result;
                imagePreview.style.display = 'flex';
                uploadLabel.style.display = 'none';
            };
            reader.readAsDataURL(croppedFile);

            // Close modal
            const cropModal = document.getElementById('cropModal');
            cropModal.style.display = 'none';
            cropper.destroy();
            cropper = null;
        }, originalFile.type);
    });

    // Close modal when clicking outside
    window.addEventListener('click', (e) => {
        const cropModal = document.getElementById('cropModal');
        if (e.target === cropModal) {
            closeCropModal();
        }
    });
</script>
{% endblock %}