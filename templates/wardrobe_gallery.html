{% extends 'base.html' %}
{% load static %}

{% block title %}My Wardrobe - Tailora{% endblock %}

{% block extra_css %}
<style>
    /* ========================================
       MODERN WARDROBE VARIABLES
       ======================================== */
    :root {
        --bg-body: #f9f9f9;
        --bg-card: #ffffff;
        --text-main: #1a1a1a;
        --text-muted: #6b7280;
        --primary: #2c2c2c;
        --primary-hover: #000000;
        --accent: #d97706; /* Warm amber */
        --border-color: #e5e7eb;
        --radius: 8px;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        
        /* Status Colors */
        --status-available: #10b981;
        --status-washing: #3b82f6;
        --status-loaned: #f59e0b;
        --status-dry-clean: #8b5cf6;
    }

    /* ========================================
       LAYOUT
       ======================================== */
    .wardrobe-wrapper {
        background-color: var(--bg-body);
        min-height: 100vh;
        padding-bottom: 60px;
    }

    .wardrobe-container {
        max-width: 1280px;
        margin: 0 auto;
        padding: 40px 24px;
    }

    /* Header Section */
    .wardrobe-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 40px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 20px;
    }

    .header-content h1 {
        font-family: 'Istok Web', sans-serif;
        font-size: 2.25rem;
        color: var(--text-main);
        font-weight: 700;
        margin: 0;
        line-height: 1.1;
    }

    .stats-pill {
        display: inline-block;
        margin-top: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 0.875rem;
        color: var(--text-muted);
        background: #eef0f2;
        padding: 4px 12px;
        border-radius: 20px;
    }

    /* Main Grid Layout */
    .wardrobe-layout {
        display: grid;
        grid-template-columns: 260px 1fr; /* Sidebar fixed width, Grid takes rest */
        gap: 40px;
        align-items: start;
    }

    /* ========================================
       SIDEBAR FILTERS
       ======================================== */
    .filter-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        padding: 24px;
        position: sticky;
        top: 24px; /* Sticky sidebar */
        box-shadow: var(--shadow-sm);
    }

    .filter-group {
        margin-bottom: 24px;
    }

    .filter-group:last-child {
        margin-bottom: 0;
    }

    .filter-title {
        font-family: 'Inter', sans-serif;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-weight: 700;
        color: var(--text-muted);
        margin-bottom: 12px;
        display: block;
    }

    /* Search Input */
    .search-box {
        position: relative;
    }
    
    .search-box svg {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .search-input {
        width: 100%;
        padding: 10px 12px 10px 36px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        font-size: 0.9rem;
        transition: all 0.2s;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0,0,0,0.05);
    }

    /* Custom Radio/Check Inputs */
    .radio-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .radio-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        color: var(--text-main);
        cursor: pointer;
        padding: 6px 8px;
        border-radius: 6px;
        transition: background 0.15s;
    }

    .radio-label:hover {
        background: #f3f4f6;
    }

    .radio-label input {
        accent-color: var(--primary);
        width: 16px;
        height: 16px;
    }

    .radio-label.active {
        font-weight: 600;
        color: var(--primary);
        background: #f3f4f6;
    }

    .styled-select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        background-color: #fff;
        font-size: 0.9rem;
        color: var(--text-main);
        cursor: pointer;
    }

    .btn-reset {
        display: block;
        width: 100%;
        text-align: center;
        padding: 10px;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-muted);
        border: 1px dashed var(--border-color);
        border-radius: var(--radius);
        margin-top: 20px;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-reset:hover {
        color: #ef4444;
        border-color: #ef4444;
        background: #fef2f2;
    }

    /* ========================================
       ITEM GRID
       ======================================== */
    .items-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 24px;
        width: 100%;
    }

    .item-card {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        overflow: hidden;
        transition: transform 0.2s, box-shadow 0.2s;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .item-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
        border-color: #d1d5db;
    }

    .item-image-wrapper {
        position: relative;
        width: 100%;
        padding-top: 100%; /* 1:1 Aspect Ratio */
        background: #f3f4f6;
        overflow: hidden;
    }

    .item-image-wrapper img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .item-card:hover .item-image-wrapper img {
        transform: scale(1.05);
    }

    /* Badges */
    .status-badge {
        position: absolute;
        bottom: 10px;
        left: 10px;
        padding: 4px 10px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: white;
        border-radius: 4px;
        z-index: 2;
        background: var(--primary); /* Fallback */
    }

    .status-washing { background: var(--status-washing); }
    .status-dry_cleaning { background: var(--status-dry-clean); }
    .status-loaned { background: var(--status-loaned); }
    .status-available { display: none; } /* Optional: Hide if available */

    .fav-icon {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--accent);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        z-index: 2;
        backdrop-filter: blur(4px);
    }

    /* Card Content */
    .card-content {
        padding: 16px;
        flex-grow: 1;
        border-bottom: 1px solid var(--border-color);
    }

    .item-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-main);
        margin: 0 0 4px 0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .item-subtitle {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin: 0;
    }

    /* Actions Footer */
    .card-actions {
        display: flex;
        background: #fafafa;
    }

    .action-btn {
        flex: 1;
        border: none;
        background: transparent;
        padding: 12px;
        color: var(--text-muted);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .action-btn:hover {
        background: white;
        color: var(--primary);
    }

    .action-btn.btn-fav.active {
        color: var(--accent);
    }

    .action-btn.btn-delete:hover {
        color: #ef4444;
        background: #fef2f2;
    }

    .card-actions > * + * {
        border-left: 1px solid var(--border-color);
    }

    /* Empty State */
    .empty-state {
        grid-column: 1 / -1;
        text-align: center;
        padding: 80px 20px;
        background: white;
        border: 2px dashed var(--border-color);
        border-radius: var(--radius);
    }

    .empty-state h3 {
        margin-top: 16px;
        color: var(--text-main);
    }

    /* ========================================
       MOBILE RESPONSIVENESS
       ======================================== */
    /* By default (Desktop), sidebar is always visible. 
       Mobile logic follows below. */

    @media (max-width: 900px) {
        .wardrobe-layout {
            display: block; /* Stack layout */
        }

        .wardrobe-sidebar {
            margin-bottom: 30px;
            position: static;
        }

        /* Mobile Filter Toggle using <details> */
        .mobile-filter-wrapper summary {
            list-style: none;
            background: white;
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .mobile-filter-wrapper summary::-webkit-details-marker {
            display: none;
        }

        .mobile-filter-wrapper summary::after {
            content: '+';
            font-size: 1.2rem;
        }

        .mobile-filter-wrapper[open] summary::after {
            content: '-';
        }

        /* Hide the actual card content until toggled on mobile */
        .mobile-filter-wrapper .filter-card {
            margin-top: 10px;
            border-top-left-radius: 0;
            border-top-right-radius: 0;
        }
    }
</style>
{% endblock %}

{% block container_class %}page-wardrobe{% endblock %}

{% block content %}
<div class="wardrobe-wrapper">
    <div class="wardrobe-container">
        
        <!-- Header -->
        <header class="wardrobe-header">
            <div class="header-content">
                <h1>My Wardrobe</h1>
                <span class="stats-pill">
                    {{ items.paginator.count|default:"0" }} Items 
                    {% if user.get_max_wardrobe_items %} / {{ user.get_max_wardrobe_items }} Limit{% endif %}
                </span>
            </div>

            <div class="header-actions">
                {% if user.wardrobe_items_count >= user.get_max_wardrobe_items %}
                    <button class="btn btn-secondary" disabled title="Wardrobe limit reached">
                        Limit Reached
                    </button>
                {% else %}
                    <a href="{% url 'wardrobe:wardrobe_upload' %}" class="btn btn-primary">
                        + Add Item
                    </a>
                {% endif %}
            </div>
        </header>

        <!-- Messages -->
        {% if messages %}
        <div class="messages-container" style="margin-bottom: 24px;">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Layout -->
        <div class="wardrobe-layout">
            
            <!-- Sidebar (Wrapped in Details for Mobile) -->
            <aside class="wardrobe-sidebar">
                <details class="mobile-filter-wrapper" open>
                    <summary class="mobile-only">Filters & Search</summary>
                    
                    <div class="filter-card">
                        <form method="get" action="{% url 'wardrobe:wardrobe_gallery' %}" id="filter-form">
                            
                            <!-- Search -->
                            <div class="filter-group">
                                <label class="filter-title">Search</label>
                                <div class="search-box">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                    <input type="text" name="search" id="search-input" 
                                           class="search-input" 
                                           placeholder="Color, brand, type..." 
                                           value="{{ search_query|default:'' }}" 
                                           autocomplete="off">
                                </div>
                            </div>

                            <!-- Categories -->
                            <div class="filter-group">
                                <label class="filter-title">Category</label>
                                <div class="radio-list">
                                    <label class="radio-label {% if not selected_category %}active{% endif %}">
                                        <input type="radio" name="category" value="" {% if not selected_category %}checked{% endif %} onchange="this.form.submit()">
                                        All Categories
                                    </label>
                                    {% for category in categories %}
                                    <label class="radio-label {% if selected_category == category.name %}active{% endif %}">
                                        <input type="radio" name="category" value="{{ category.name }}" {% if selected_category == category.name %}checked{% endif %} onchange="this.form.submit()">
                                        {{ category.name }}
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>

                            <!-- Filters Row (Season/Status) -->
                            <div class="filter-group">
                                <label class="filter-title">Season</label>
                                <select name="season" class="styled-select" onchange="this.form.submit()">
                                    <option value="">Any Season</option>
                                    <option value="spring" {% if selected_season == 'spring' %}selected{% endif %}>Spring</option>
                                    <option value="summer" {% if selected_season == 'summer' %}selected{% endif %}>Summer</option>
                                    <option value="fall" {% if selected_season == 'fall' %}selected{% endif %}>Fall</option>
                                    <option value="winter" {% if selected_season == 'winter' %}selected{% endif %}>Winter</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label class="filter-title">Status</label>
                                <select name="status" class="styled-select" onchange="this.form.submit()">
                                    <option value="">Any Status</option>
                                    <option value="available" {% if selected_status == 'available' %}selected{% endif %}>Available</option>
                                    <option value="washing" {% if selected_status == 'washing' %}selected{% endif %}>Washing</option>
                                    <option value="dry_cleaning" {% if selected_status == 'dry_cleaning' %}selected{% endif %}>Dry Cleaning</option>
                                    <option value="loaned" {% if selected_status == 'loaned' %}selected{% endif %}>Loaned</option>
                                </select>
                            </div>

                            <!-- Favorites Toggle -->
                            <div class="filter-group" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                                <label class="radio-label" style="font-weight: 600;">
                                    <input type="checkbox" name="favorites" value="true" {% if show_favorites %}checked{% endif %} onchange="this.form.submit()">
                                    <span style="color: var(--accent)">â˜…</span> Show Favorites Only
                                </label>
                            </div>

                            <!-- Reset Button -->
                            {% if search_query or selected_category or selected_season or selected_status or show_favorites %}
                            <a href="{% url 'wardrobe:wardrobe_gallery' %}" class="btn-reset">
                                Clear All Filters
                            </a>
                            {% endif %}
                        </form>
                    </div>
                </details>
            </aside>

            <!-- Main Gallery -->
            <main class="wardrobe-main">
                <div class="items-grid">
                    {% if items %}
                        {% for item in items %}
                        <article class="item-card">
                            <a href="{% url 'wardrobe:wardrobe_detail' item.id %}" style="text-decoration: none; color: inherit; display: contents;">
                                
                                <div class="item-image-wrapper">
                                    <img src="{{ item.image.url }}" alt="{{ item.name }}" loading="lazy">
                                    
                                    <!-- Favorite Icon Overlay -->
                                    {% if item.favorite %}
                                    <div class="fav-icon" title="Favorite">
                                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                                    </div>
                                    {% endif %}

                                    <!-- Status Badge -->
                                    {% if item.status != 'available' %}
                                    <span class="status-badge status-{{ item.status }}">
                                        {{ item.get_status_display }}
                                    </span>
                                    {% endif %}
                                </div>

                                <div class="card-content">
                                    <h3 class="item-title">{{ item.name }}</h3>
                                    <p class="item-subtitle">{{ item.category.name|default:"Uncategorized" }}</p>
                                </div>
                            </a>

                            <!-- Card Actions -->
                            <div class="card-actions">
                                <a href="{% url 'wardrobe:wardrobe_toggle_favorite' item.id %}" 
                                   class="action-btn btn-fav {% if item.favorite %}active{% endif %}" 
                                   title="Toggle Favorite">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="{% if item.favorite %}currentColor{% else %}none{% endif %}" stroke="currentColor" stroke-width="2">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                                    </svg>
                                </a>
                                <a href="{% url 'wardrobe:wardrobe_edit' item.id %}" class="action-btn" title="Edit">
                                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                </a>
                                <form method="post" action="{% url 'wardrobe:wardrobe_delete' item.id %}" style="flex: 1; display: flex;" onsubmit="return confirm('Delete this item?')">
                                    {% csrf_token %}
                                    <button type="submit" class="action-btn btn-delete" title="Delete">
                                        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </form>
                            </div>
                        </article>
                        {% endfor %}
                    {% else %}
                        <div class="empty-state">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ§¥</div>
                            <h3>No items found</h3>
                            <p style="color: var(--text-muted); margin-bottom: 20px;">
                                {% if search_query or selected_category %}
                                Try adjusting your filters or search terms.
                                {% else %}
                                Your wardrobe is looking a bit empty. Time to add some style!
                                {% endif %}
                            </p>
                            <a href="{% url 'wardrobe:wardrobe_upload' %}" class="btn btn-primary">Add New Item</a>
                        </div>
                    {% endif %}
                </div>

                <!-- Pagination -->
                {% if items.has_other_pages %}
                <div class="pagination-container" style="display: flex; justify-content: center; margin-top: 40px; gap: 10px;">
                    {% if items.has_previous %}
                        <a href="?page={{ items.previous_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="btn btn-secondary">Previous</a>
                    {% endif %}
                    
                    <span style="display: flex; align-items: center; color: var(--text-muted);">
                        Page {{ items.number }} of {{ items.paginator.num_pages }}
                    </span>

                    {% if items.has_next %}
                        <a href="?page={{ items.next_page_number }}{% if request.GET.urlencode %}&{{ request.GET.urlencode }}{% endif %}" class="btn btn-secondary">Next</a>
                    {% endif %}
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Mobile Toggle Logic: Close details automatically on desktop resize
        const mobileDetails = document.querySelector('.mobile-filter-wrapper');
        const checkScreen = () => {
            if (window.innerWidth > 900) {
                if (mobileDetails) mobileDetails.setAttribute('open', '');
                // Disable click on summary for desktop
                if (mobileDetails) mobileDetails.querySelector('summary').style.pointerEvents = 'none';
            } else {
                if (mobileDetails) mobileDetails.removeAttribute('open'); // Default closed on mobile
                if (mobileDetails) mobileDetails.querySelector('summary').style.pointerEvents = 'auto';
            }
        };
        
        // Initial check
        checkScreen();
        window.addEventListener('resize', checkScreen);

        // Search Debounce Logic
        const searchInput = document.getElementById('search-input');
        const filterForm = document.getElementById('filter-form');
        let timeout = null;

        if (searchInput && filterForm) {
            // Restore focus
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('search')) {
                const len = searchInput.value.length;
                searchInput.focus();
                searchInput.setSelectionRange(len, len);
            }

            searchInput.addEventListener('input', function() {
                clearTimeout(timeout);
                timeout = setTimeout(() => filterForm.submit(), 500);
            });

            searchInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(timeout);
                    filterForm.submit();
                }
            });
        }
    });
</script>
{% endblock %}