{% extends 'base.html' %}
{% load static %}

{% block title %}Calendar - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/planner.css' %}">
<link rel="stylesheet" href="{% static 'css/settings.css' %}">
<style>
    /* Enhanced Calendar Styles - Matching App Design Language */
    .calendar-day-events {
        display: flex;
        flex-direction: column;
        gap: 2px;
        margin-top: 4px;
        max-height: 60px;
        overflow-y: auto;
    }
    .calendar-event-chip {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
        font-weight: 600;
        text-decoration: none;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .calendar-event-chip:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .calendar-event-chip.work { background: #4a90e2; }
    .calendar-event-chip.casual { background: #7ed321; }
    .calendar-event-chip.formal { background: #bd10e0; }
    .calendar-event-chip.party { background: #f5a623; }
    .calendar-event-chip.date { background: #e94b3c; }
    .calendar-event-chip.sports { background: #50e3c2; color: #2c2c2c; }
    .calendar-event-chip.travel { background: #9013fe; }
    .calendar-event-chip.other { background: #8b8b8b; }
    
    /* Enhanced Weather Widget - Consistent with App Design */
    .weather-widget-enhanced {
        padding: 20px;
        background: #2c2c2c;
        color: #fff;
    }
    .weather-location {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .weather-location-name {
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #f4e9cf;
    }
    .weather-main-display {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 16px;
    }
    .weather-icon-large {
        font-size: 48px;
    }
    .weather-temp-main {
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        color: #fff;
    }
    .weather-condition {
        font-size: 14px;
        opacity: 0.9;
        text-transform: capitalize;
        color: #f4e9cf;
    }
    .weather-details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 16px 0;
        border-top: 1px solid rgba(255,255,255,0.15);
        border-bottom: 1px solid rgba(255,255,255,0.15);
        margin-bottom: 16px;
    }
    .weather-detail-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        color: rgba(255,255,255,0.85);
    }
    .weather-detail-icon {
        font-size: 14px;
        opacity: 0.8;
    }
    .outfit-suggestion {
        padding: 10px;
        background: rgba(255,255,255,0.15);
        border-radius: 8px;
        font-size: 12px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
    }
    .outfit-suggestion-icon {
        font-size: 18px;
    }
    .outfit-suggestion-text strong {
        display: block;
        margin-bottom: 2px;
    }
    
    /* Forecast List Enhanced */
    .forecast-list-enhanced {
        margin-top: 16px;
    }
    .forecast-day-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 12px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s;
    }
    .forecast-day-item:hover {
        background: #f0f0f0;
        transform: translateX(4px);
    }
    .forecast-day-name {
        font-weight: 600;
        font-size: 13px;
        min-width: 80px;
    }
    .forecast-condition {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #666;
    }
    .forecast-temps {
        display: flex;
        gap: 8px;
        font-size: 13px;
    }
    .temp-high {
        font-weight: 700;
        color: #e94b3c;
    }
    .temp-low {
        color: #4a90e2;
    }
    
    /* Location Selector */
    .location-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
    }
    .location-selector input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 13px;
    }
    .location-selector button {
        padding: 8px 16px;
        background: #2c2c2c;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
    }
    .location-selector button:hover {
        background: #444;
    }
    
    /* More Events Indicator */
    .more-events {
        font-size: 9px;
        color: #666;
        text-align: center;
        padding: 2px;
        background: #f0f0f0;
        border-radius: 3px;
        margin-top: 2px;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">Calendar & Events</h1>
        <p class="page-subtitle">Plan your outfits for upcoming occasions</p>
    </div>
    <a href="{% url 'planner:event_create' %}" class="btn btn-primary">
        <span>+ New Event</span>
    </a>
</div>

{% if messages %}
{% for message in messages %}
<div class="alert alert-{{ message.tags }}">{{ message }}</div>
{% endfor %}
{% endif %}

<div class="planner-layout">
    <!-- Calendar -->
    <div class="calendar-section content-section">
        <div class="calendar-header">
            <h2 class="section-title">{{ month_name }} {{ year }}</h2>
            <div class="calendar-nav">
                <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn btn-secondary btn-sm">‚Üê Prev</a>
                <a href="?year={{ today.year }}&month={{ today.month }}" class="btn btn-secondary btn-sm">Today</a>
                <a href="?year={{ next_year }}&month={{ next_month }}" class="btn btn-secondary btn-sm">Next ‚Üí</a>
            </div>
        </div>

        <div class="calendar-grid">
            <!-- Weekday headers -->
            {% for day in weekday_names %}
            <div class="calendar-weekday">{{ day }}</div>
            {% endfor %}

            <!-- Calendar days -->
            {% for week in month_calendar %}
            {% for day in week %}
            {% if day == 0 %}
            <div class="calendar-day empty"></div>
            {% else %}
            <div class="calendar-day {% if day == today.day and month == today.month and year == today.year %}today{% endif %}">
                <span class="day-number">{{ day }}</span>
                {% if day in events_by_date %}
                <div class="calendar-day-events">
                    {% for event in events_by_date|dictsort:day %}
                    {% if forloop.counter <= 2 %}
                    <a href="{% url 'planner:event_detail' event.id %}" class="calendar-event-chip {{ event.occasion_type }}" title="{{ event.title }}{% if event.time %} at {{ event.time|date:'g:i A' }}{% endif %}">
                        {{ event.title|truncatechars:12 }}
                    </a>
                    {% endif %}
                    {% endfor %}
                    {% with event_count=events_by_date|length %}
                    {% if event_count > 2 %}
                    <span class="more-events">+{{ event_count|add:"-2" }} more</span>
                    {% endif %}
                    {% endwith %}
                </div>
                {% endif %}
            </div>
            {% endif %}
            {% endfor %}
            {% endfor %}
        </div>
    </div>

    <!-- Upcoming Events Sidebar -->
    <div class="sidebar-section">
        <!-- Enhanced Weather Widget -->
        <div class="content-section" style="margin-bottom: 1.5rem; padding: 0; overflow: hidden;">
            <div class="weather-widget-enhanced">
                <div class="weather-location">
                    <span class="weather-location-name">üìç {{ weather_location|default:"Tunis" }}</span>
                    <button onclick="document.getElementById('location-modal').style.display='flex'" style="background: rgba(255,255,255,0.2); border: none; color: #fff; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">Change</button>
                </div>
                {% if current_weather %}
                <div class="weather-main-display">
                    <span class="weather-icon-large">
                        {% if current_weather.condition == 'clear' %}‚òÄÔ∏è
                        {% elif current_weather.condition == 'clouds' %}‚òÅÔ∏è
                        {% elif current_weather.condition == 'rain' or current_weather.condition == 'drizzle' %}üåßÔ∏è
                        {% elif current_weather.condition == 'thunderstorm' %}‚õàÔ∏è
                        {% elif current_weather.condition == 'snow' %}‚ùÑÔ∏è
                        {% elif current_weather.condition == 'mist' or current_weather.condition == 'fog' %}üå´Ô∏è
                        {% else %}üå§Ô∏è{% endif %}
                    </span>
                    <div>
                        <div class="weather-temp-main">{{ current_weather.temperature }}¬∞</div>
                        <div class="weather-condition">{{ current_weather.description|default:current_weather.condition }}</div>
                    </div>
                </div>
                
                <div class="weather-details-grid">
                    <div class="weather-detail-item">
                        <span class="weather-detail-icon">üå°Ô∏è</span>
                        <span>Feels {{ current_weather.feels_like }}¬∞C</span>
                    </div>
                    <div class="weather-detail-item">
                        <span class="weather-detail-icon">üíß</span>
                        <span>{{ current_weather.humidity }}% humidity</span>
                    </div>
                    <div class="weather-detail-item">
                        <span class="weather-detail-icon">üí®</span>
                        <span>{{ current_weather.wind_speed }} km/h</span>
                    </div>
                    <div class="weather-detail-item">
                        <span class="weather-detail-icon">üìä</span>
                        <span>{% if current_weather.temperature > 30 %}Hot{% elif current_weather.temperature > 20 %}Warm{% elif current_weather.temperature > 10 %}Cool{% else %}Cold{% endif %}</span>
                    </div>
                </div>
                
                <div class="outfit-suggestion">
                    <span class="outfit-suggestion-icon">üëî</span>
                    <div class="outfit-suggestion-text">
                        <strong>Today's Suggestion</strong>
                        {% if current_weather.temperature > 28 %}
                        Light, breathable fabrics. Consider shorts or a light dress.
                        {% elif current_weather.temperature > 20 %}
                        Perfect for a casual outfit. Light layers work great.
                        {% elif current_weather.temperature > 12 %}
                        Add a light jacket or cardigan for comfort.
                        {% else %}
                        Layer up! A warm coat and sweater recommended.
                        {% endif %}
                        {% if current_weather.condition == 'rain' or current_weather.condition == 'drizzle' %}
                        Don't forget an umbrella!
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div style="padding: 20px; text-align: center; opacity: 0.8;">
                    <span style="font-size: 32px;">üå§Ô∏è</span>
                    <p style="margin: 8px 0 0;">Weather data unavailable</p>
                </div>
                {% endif %}
            </div>
            
            {% if weather_forecast %}
            <div class="forecast-list-enhanced" style="padding: 16px;">
                <h4 style="font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: #888; margin-bottom: 12px;">5-Day Forecast</h4>
                {% for day in weather_forecast %}
                <div class="forecast-day-item">
                    <span class="forecast-day-name">{{ day.day_name|slice:":3" }}</span>
                    <span class="forecast-condition">
                        {% if day.condition == 'clear' %}‚òÄÔ∏è
                        {% elif day.condition == 'clouds' %}‚òÅÔ∏è
                        {% elif day.condition == 'rain' %}üåßÔ∏è
                        {% elif day.condition == 'snow' %}‚ùÑÔ∏è
                        {% else %}üå§Ô∏è{% endif %}
                        {{ day.condition }}
                    </span>
                    <div class="forecast-temps">
                        <span class="temp-high">{{ day.temp_max }}¬∞</span>
                        <span class="temp-low">{{ day.temp_min }}¬∞</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="content-section">
            <h3 class="section-title">UPCOMING EVENTS</h3>
            {% if upcoming_events %}
            <div class="upcoming-list">
                {% for event in upcoming_events %}
                <a href="{% url 'planner:event_detail' event.id %}" class="upcoming-item">
                    <div class="event-date">
                        <span class="date-day">{{ event.date.day }}</span>
                        <span class="date-month">{{ event.date|date:"M" }}</span>
                    </div>
                    <div class="event-info">
                        <div class="event-title">{{ event.title }}</div>
                        {% if event.time %}
                        <div class="event-time">{{ event.time|date:"g:i A" }}</div>
                        {% endif %}
                        {% if event.outfit %}
                        <div class="event-outfit">Outfit Planned</div>
                        {% else %}
                        <div class="event-no-outfit">No outfit yet</div>
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            </div>
            {% else %}
            <p class="empty-state">No upcoming events in the next 7 days</p>
            {% endif %}

            <div class="sidebar-actions">
                <a href="{% url 'planner:event_list' %}" class="btn btn-secondary btn-block">View All Events</a>
                <a href="{% url 'planner:event_stats' %}" class="btn btn-secondary btn-block">View Statistics</a>
            </div>
        </div>

        <!-- Legend -->
        <div class="content-section">
            <h4 class="section-title">EVENT TYPES</h4>
            <div class="event-legend">
                <div class="legend-item"><span class="legend-dot work"></span> Work</div>
                <div class="legend-item"><span class="legend-dot casual"></span> Casual</div>
                <div class="legend-item"><span class="legend-dot formal"></span> Formal</div>
                <div class="legend-item"><span class="legend-dot party"></span> Party</div>
                <div class="legend-item"><span class="legend-dot date"></span> Date</div>
                <div class="legend-item"><span class="legend-dot sports"></span> Sports</div>
                <div class="legend-item"><span class="legend-dot travel"></span> Travel</div>
            </div>
        </div>
    </div>
</div>

<!-- Location Change Modal -->
<div id="location-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #fff; padding: 24px; border-radius: 12px; max-width: 400px; width: 90%;">
        <h3 style="margin: 0 0 16px; font-size: 18px;">Change Weather Location</h3>
        <form method="get" action="">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600;">City Name</label>
                <input type="text" name="location" value="{{ weather_location|default:'Tunis' }}" placeholder="e.g., Paris, London, New York" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                <small style="color: #888; font-size: 11px; margin-top: 4px; display: block;">Enter city name (optionally with country code: Paris,FR)</small>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="document.getElementById('location-modal').style.display='none'" style="padding: 10px 20px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                <button type="submit" style="padding: 10px 20px; background: #2c2c2c; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
// Close modal when clicking outside
document.getElementById('location-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        this.style.display = 'none';
    }
});
</script>
{% endblock %}