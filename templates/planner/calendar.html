{% extends 'base.html' %}
{% load static %}
{% load planner_extras %}

{% block title %}Calendar - Tailora{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<style>
    /* =========================================
       CALENDAR - TAILORA DESIGN SYSTEM
       ========================================= */
    
    /* Page Layout */
    .calendar-wrapper {
        background-color: #ffffff;
        min-height: 100vh;
    }

    .calendar-layout {
        display: grid;
        grid-template-columns: 1fr 340px;
        gap: 32px;
        align-items: start;
    }

    /* Calendar Section */
    .calendar-section {
        background: #ffffff;
        border: 1px solid #d9d9d9;
        padding: 32px;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
        flex-wrap: wrap;
        gap: 16px;
    }

    .calendar-title {
        font-family: 'Istok Web', sans-serif;
        font-size: 28px;
        font-weight: 700;
        color: #252320;
        margin: 0;
    }

    .calendar-subtitle {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        color: #757575;
        margin: 4px 0 0 0;
    }

    .calendar-nav {
        display: flex;
        gap: 0;
    }

    .btn-cal-nav {
        padding: 12px 18px;
        font-family: 'Inter', sans-serif;
        font-size: 13px;
        font-weight: 600;
        border: 1px solid #d9d9d9;
        background: #ffffff;
        color: #252320;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-cal-nav:first-child {
        border-right: none;
    }

    .btn-cal-nav:last-child {
        border-left: none;
    }

    .btn-cal-nav:hover {
        background: #2c2c2c;
        color: #ffffff;
        border-color: #2c2c2c;
    }

    /* Quick Actions */
    .quick-actions-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 24px;
        flex-wrap: wrap;
    }

    .quick-action-link {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 18px;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        font-weight: 600;
        text-decoration: none;
        border: 1px solid #d9d9d9;
        background: #ffffff;
        color: #252320;
        transition: all 0.2s ease;
    }

    .quick-action-link:hover {
        background: #2c2c2c;
        color: #ffffff;
        border-color: #2c2c2c;
    }

    /* Calendar Grid */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 0;
        border: 1px solid #d9d9d9;
        background: #d9d9d9;
    }

    .calendar-weekday {
        background: #fafafa;
        color: #757575;
        font-family: 'Inter', sans-serif;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        padding: 14px 12px;
        text-align: center;
        letter-spacing: 1px;
        border-bottom: 1px solid #d9d9d9;
    }

    .calendar-day {
        background: #ffffff;
        min-height: 120px;
        padding: 10px;
        position: relative;
        transition: background 0.2s ease;
        border: 1px solid #d9d9d9;
        border-top: none;
        border-left: none;
    }

    .calendar-day:nth-child(7n) {
        border-right: none;
    }

    .calendar-day:hover {
        background: #fafafa;
    }

    .calendar-day.today {
        background: #fef7ed;
    }

    .calendar-day.today::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: #2c2c2c;
    }

    .day-number {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
        color: #252320;
        display: block;
        margin-bottom: 8px;
    }

    .calendar-day.today .day-number {
        font-weight: 700;
    }

    .calendar-day.empty {
        background: #fafafa;
    }

    /* Events in Calendar */
    .calendar-day-events {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .calendar-event-chip {
        display: block;
        padding: 4px 8px;
        font-family: 'Inter', sans-serif;
        font-size: 11px;
        font-weight: 600;
        color: #ffffff;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        transition: transform 0.1s ease;
    }

    .calendar-event-chip:hover {
        transform: translateY(-1px);
    }

    /* Event Colors */
    .calendar-event-chip.work { background: #555555; }
    .calendar-event-chip.casual { background: #7c8ab8; }
    .calendar-event-chip.formal { background: #2c2c2c; }
    .calendar-event-chip.party { background: #c9a55c; }
    .calendar-event-chip.date { background: #b85c5c; }
    .calendar-event-chip.sports { background: #6b9b7a; }
    .calendar-event-chip.travel { background: #9678a8; }
    .calendar-event-chip.other { background: #757575; }

    .more-events {
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        color: #757575;
        text-align: center;
        margin-top: 4px;
        font-weight: 600;
    }

    /* Legend */
    .calendar-legend {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-top: 24px;
        padding-top: 24px;
        border-top: 1px solid #d9d9d9;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        color: #757575;
    }

    .legend-dot {
        width: 10px;
        height: 10px;
    }

    .legend-dot.work { background: #555555; }
    .legend-dot.casual { background: #7c8ab8; }
    .legend-dot.formal { background: #2c2c2c; }
    .legend-dot.party { background: #c9a55c; }

    /* Calendar Footer */
    .calendar-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 24px;
        flex-wrap: wrap;
        gap: 16px;
    }

    /* Sidebar */
    .sidebar-section {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Weather Widget */
    .weather-widget {
        background: #2c2c2c;
        color: #ffffff;
        padding: 28px;
    }

    .weather-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .weather-location {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .weather-change-btn {
        background: rgba(255, 255, 255, 0.15);
        border: none;
        color: #ffffff;
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        font-weight: 700;
        padding: 6px 12px;
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: background 0.2s ease;
    }

    .weather-change-btn:hover {
        background: rgba(255, 255, 255, 0.25);
    }

    .weather-main {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
    }

    .weather-temp {
        font-family: 'Istok Web', sans-serif;
        font-size: 56px;
        font-weight: 700;
        line-height: 1;
        letter-spacing: -2px;
    }

    .weather-condition {
        font-family: 'Inter', sans-serif;
        font-size: 16px;
        opacity: 0.9;
    }

    .weather-feels {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        opacity: 0.6;
        margin-top: 4px;
    }

    .weather-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 24px;
    }

    .weather-detail {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .weather-detail-label {
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        text-transform: uppercase;
        opacity: 0.5;
        letter-spacing: 1px;
    }

    .weather-detail-value {
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        font-weight: 600;
    }

    .weather-tip {
        background: rgba(255, 255, 255, 0.08);
        padding: 16px;
        border-left: 3px solid #f4e9cf;
    }

    .weather-tip-label {
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        color: #f4e9cf;
        margin-bottom: 6px;
        letter-spacing: 0.5px;
    }

    .weather-tip-text {
        font-family: 'Inter', sans-serif;
        font-size: 13px;
        line-height: 1.5;
        color: rgba(255, 255, 255, 0.9);
    }

    /* Upcoming Events Widget */
    .upcoming-widget {
        background: #ffffff;
        border: 1px solid #d9d9d9;
    }

    .upcoming-header {
        padding: 20px;
        border-bottom: 1px solid #d9d9d9;
        background: #fafafa;
    }

    .upcoming-title {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        color: #252320;
        letter-spacing: 1px;
        margin: 0;
    }

    .upcoming-item {
        display: flex;
        gap: 16px;
        padding: 16px 20px;
        border-bottom: 1px solid #f0f0f0;
        text-decoration: none;
        color: inherit;
        transition: background 0.2s ease;
    }

    .upcoming-item:last-child {
        border-bottom: none;
    }

    .upcoming-item:hover {
        background: #fafafa;
    }

    .date-box {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        background: #f4e9cf;
        color: #252320;
        flex-shrink: 0;
    }

    .date-box-day {
        font-family: 'Istok Web', sans-serif;
        font-size: 20px;
        font-weight: 700;
        line-height: 1;
    }

    .date-box-month {
        font-family: 'Inter', sans-serif;
        font-size: 10px;
        text-transform: uppercase;
        font-weight: 700;
        margin-top: 2px;
    }

    .upcoming-info {
        flex: 1;
        min-width: 0;
    }

    .upcoming-info-title {
        font-family: 'Inter', sans-serif;
        font-weight: 600;
        font-size: 15px;
        margin-bottom: 4px;
        color: #252320;
    }

    .upcoming-info-meta {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        color: #757575;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .outfit-ready {
        color: #4caf50;
        font-weight: 600;
    }

    .upcoming-footer {
        padding: 14px 20px;
        text-align: center;
        border-top: 1px solid #f0f0f0;
        background: #fafafa;
    }

    .upcoming-footer a {
        font-family: 'Inter', sans-serif;
        font-size: 12px;
        font-weight: 700;
        color: #252320;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .upcoming-footer a:hover {
        color: #000000;
    }

    .upcoming-empty {
        padding: 32px 20px;
        text-align: center;
        color: #757575;
        font-family: 'Inter', sans-serif;
        font-size: 13px;
    }

    /* Location Modal */
    .location-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .location-modal.active {
        display: flex;
    }

    .location-modal-content {
        background: #ffffff;
        padding: 32px;
        width: 90%;
        max-width: 400px;
    }

    .location-modal-title {
        font-family: 'Istok Web', sans-serif;
        font-size: 22px;
        font-weight: 700;
        margin: 0 0 24px 0;
        color: #252320;
    }

    .location-form-group {
        margin-bottom: 24px;
    }

    .location-form-label {
        font-family: 'Inter', sans-serif;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #757575;
        display: block;
        margin-bottom: 8px;
    }

    .location-form-input {
        width: 100%;
        padding: 14px 16px;
        font-family: 'Inter', sans-serif;
        font-size: 14px;
        border: 1px solid #d9d9d9;
        background: #ffffff;
        color: #252320;
        box-sizing: border-box;
    }

    .location-form-input:focus {
        outline: none;
        border-color: #2c2c2c;
    }

    .location-modal-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    /* Responsive */
    @media (max-width: 1100px) {
        .calendar-layout {
            grid-template-columns: 1fr;
        }

        .sidebar-section {
            order: 2;
        }
    }

    @media (max-width: 600px) {
        .calendar-section {
            padding: 20px;
        }

        .calendar-day {
            min-height: 80px;
            padding: 6px;
        }

        .day-number {
            font-size: 12px;
        }

        .calendar-event-chip {
            font-size: 9px;
            padding: 2px 4px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-wrapper">
    <div class="calendar-layout">

        <!-- Main Calendar Area -->
        <div class="calendar-section">
            <div class="calendar-header">
                <div>
                    <h1 class="calendar-title">{{ month_name }} {{ year }}</h1>
                    <p class="calendar-subtitle">Plan your outfits for each day</p>
                </div>
                <div class="calendar-nav">
                    <a href="?year={{ prev_year }}&month={{ prev_month }}" class="btn-cal-nav">← Prev</a>
                    <a href="?year={{ today.year }}&month={{ today.month }}" class="btn-cal-nav">Today</a>
                    <a href="?year={{ next_year }}&month={{ next_month }}" class="btn-cal-nav">Next →</a>
                </div>
            </div>

            <!-- Quick Actions Bar -->
            <div class="quick-actions-bar">
                <a href="{% url 'planner:weekly_planner' %}" class="quick-action-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5z"></path><path d="M2 17l10 5 10-5"></path><path d="M2 12l10 5 10-5"></path></svg>
                    AI Weekly Planner
                </a>
                <a href="{% url 'wardrobe:laundry_dashboard' %}" class="quick-action-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18l-2 13H5L3 6z"></path><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                    Laundry Dashboard
                </a>
                <a href="{% url 'planner:event_list' %}" class="quick-action-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                    All Events
                </a>
            </div>

            <div class="calendar-grid">
                <!-- Weekday headers -->
                {% for day in weekday_names %}
                <div class="calendar-weekday">{{ day|slice:":3" }}</div>
                {% endfor %}

                <!-- Calendar days -->
                {% for week in month_calendar %}
                {% for day in week %}
                {% if day == 0 %}
                <div class="calendar-day empty"></div>
                {% else %}
                <div class="calendar-day {% if day == today.day and month == today.month and year == today.year %}today{% endif %}">
                    <span class="day-number">{{ day }}</span>

                    {% with events_for_day=events_by_date|get_item:day %}
                    {% if events_for_day %}
                    <div class="calendar-day-events">
                        {% for event in events_for_day %}
                        {% if forloop.counter <= 3 %}
                        <a href="{% url 'planner:event_detail' event.id %}" class="calendar-event-chip {{ event.occasion_type|slugify }}" title="{{ event.title }}">
                            {{ event.title }}
                        </a>
                        {% endif %}
                        {% endfor %}

                        {% if events_for_day|length > 3 %}
                        <span class="more-events">+{{ events_for_day|length|add:"-3" }} more</span>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endwith %}
                </div>
                {% endif %}
                {% endfor %}
                {% endfor %}
            </div>

            <!-- Calendar Footer -->
            <div class="calendar-footer">
                <div class="calendar-legend">
                    <div class="legend-item"><span class="legend-dot work"></span> Work</div>
                    <div class="legend-item"><span class="legend-dot casual"></span> Casual</div>
                    <div class="legend-item"><span class="legend-dot formal"></span> Formal</div>
                    <div class="legend-item"><span class="legend-dot party"></span> Party</div>
                </div>
                <a href="{% url 'planner:event_create' %}" class="btn btn-primary">+ Add Event</a>
            </div>
        </div>

        <!-- Sidebar -->
        <aside class="sidebar-section">

            <!-- Weather Widget -->
            <div class="weather-widget">
                <div class="weather-header">
                    <span class="weather-location">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                            <circle cx="12" cy="10" r="3"></circle>
                        </svg>
                        {{ weather_location|default:"Tunis" }}
                    </span>
                    <button onclick="document.getElementById('location-modal').classList.add('active')" class="weather-change-btn">
                        Change
                    </button>
                </div>

                {% if current_weather %}
                <div class="weather-main">
                    <span class="weather-temp">{{ current_weather.temperature }}°</span>
                    <div>
                        <div class="weather-condition">{{ current_weather.condition|title }}</div>
                        <div class="weather-feels">Feels like {{ current_weather.feels_like }}°</div>
                    </div>
                </div>

                <div class="weather-details">
                    <div class="weather-detail">
                        <span class="weather-detail-label">Wind</span>
                        <span class="weather-detail-value">{{ current_weather.wind_speed }} km/h</span>
                    </div>
                    <div class="weather-detail">
                        <span class="weather-detail-label">Humidity</span>
                        <span class="weather-detail-value">{{ current_weather.humidity }}%</span>
                    </div>
                </div>

                <div class="weather-tip">
                    <div class="weather-tip-label">Styling Tip</div>
                    <div class="weather-tip-text">
                        {% if current_weather.temperature > 28 %}
                        Light fabrics and shorts recommended.
                        {% elif current_weather.temperature > 20 %}
                        Great weather for light layers.
                        {% elif current_weather.temperature > 12 %}
                        Bring a jacket or cardigan.
                        {% else %}
                        Bundle up with a warm coat.
                        {% endif %}
                    </div>
                </div>
                {% else %}
                <div style="text-align: center; padding: 20px; color: rgba(255,255,255,0.5); font-family: 'Inter', sans-serif; font-size: 13px;">
                    Weather data unavailable
                </div>
                {% endif %}
            </div>

            <!-- Upcoming Events Widget -->
            <div class="upcoming-widget">
                <div class="upcoming-header">
                    <h3 class="upcoming-title">Upcoming Events</h3>
                </div>

                {% if upcoming_events %}
                {% for event in upcoming_events|slice:":5" %}
                <a href="{% url 'planner:event_detail' event.id %}" class="upcoming-item">
                    <div class="date-box">
                        <span class="date-box-day">{{ event.date.day }}</span>
                        <span class="date-box-month">{{ event.date|date:"M" }}</span>
                    </div>
                    <div class="upcoming-info">
                        <div class="upcoming-info-title">{{ event.title }}</div>
                        <div class="upcoming-info-meta">
                            <span>{{ event.time|date:"g:i A" }}</span>
                            {% if event.outfit %}
                            <span>•</span>
                            <span class="outfit-ready">Outfit Ready</span>
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}

                <div class="upcoming-footer">
                    <a href="{% url 'planner:event_list' %}">View All Events →</a>
                </div>
                {% else %}
                <div class="upcoming-empty">
                    No upcoming events scheduled.
                </div>
                {% endif %}
            </div>

        </aside>
    </div>
</div>

<!-- Location Change Modal -->
<div id="location-modal" class="location-modal">
    <div class="location-modal-content">
        <h3 class="location-modal-title">Change Location</h3>
        <form method="get" action="">
            <input type="hidden" name="year" value="{{ year }}">
            <input type="hidden" name="month" value="{{ month }}">
            <div class="location-form-group">
                <label class="location-form-label">City Name</label>
                <input type="text" name="location" value="{{ weather_location|default:'Tunis' }}" placeholder="e.g., Paris" class="location-form-input">
            </div>
            <div class="location-modal-actions">
                <button type="button" onclick="document.getElementById('location-modal').classList.remove('active')" class="btn btn-secondary">Cancel</button>
                <button type="submit" class="btn btn-primary">Update</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Close modal when clicking outside
    document.getElementById('location-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('active');
        }
    });
</script>
{% endblock %}
