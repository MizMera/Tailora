{% extends 'base.html' %}
{% load static %}

{% block title %}AI Style Assistant - Tailora{% endblock %}

{% block extra_css %}
<style>
    /* =========================================
       THEME VARIABLES (Matching Profile Settings)
       ========================================= */
    :root {
        --bg-color: #f8f8f8;
        --card-bg: #ffffff;
        --text-main: #1a1a1a;
        --text-muted: #757575;
        --border-color: #e0e0e0;
        --accent-color: #2c2c2c;
    }

    /* =========================================
       LAYOUT
       ========================================= */
    .ai-wrapper {
        background-color: var(--bg-color);
        min-height: 100vh;
        padding: 40px 24px;
        font-family: 'Inter', sans-serif;
    }

    .ai-container {
        max-width: 900px;
        margin: 0 auto;
    }

    /* Steps Header */
    .steps-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .steps-title {
        font-family: 'Istok Web', sans-serif;
        font-size: 32px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    .steps-subtitle {
        color: var(--text-muted);
        font-size: 16px;
    }

    /* Cards */
    .ai-card {
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        padding: 40px;
        margin-bottom: 24px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.02);
    }

    /* Upload Zone */
    .upload-zone {
        border: 2px dashed #ccc;
        background: #fafafa;
        padding: 60px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }

    .upload-zone:hover,
    .upload-zone.dragover {
        border-color: var(--text-main);
        background: #f0f0f0;
    }

    .upload-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    /* Results Grid */
    .results-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
    }

    .persona-card {
        background: #fcfcfc;
        padding: 40px;
        text-align: center;
        border: 1px solid var(--border-color);
    }

    .persona-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1.5px;
        color: var(--text-muted);
        margin-bottom: 16px;
    }

    .persona-value {
        font-family: 'Istok Web', sans-serif;
        font-size: 42px;
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 8px;
    }

    /* Colors */
    .palette-row {
        display: flex;
        gap: 16px;
        justify-content: center;
        margin-top: 20px;
    }

    .palette-swatch {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        border: 1px solid rgba(0, 0, 0, 0.08);
        /* Subtle border for white */
        position: relative;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    /* Analyzed Images Breakdown */
    .image-breakdown-card {
        background: #fff;
        border: 1px solid var(--border-color);
        padding: 24px;
        margin-top: 24px;
    }

    .image-strip {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        /* Fixed width columns */
        gap: 16px;
        padding: 12px 0;
    }

    .breakdown-item {
        background: #f9f9f9;
        border: 1px solid #eee;
        padding: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .breakdown-thumb-placeholder {
        width: 100%;
        height: 100px;
        background: #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #999;
        margin-bottom: 12px;
        overflow: hidden;
        text-align: center;
        padding: 4px;
    }

    .breakdown-info {
        width: 100%;
        text-align: left;
    }

    .breakdown-text {
        font-size: 11px;
        line-height: 1.5;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .breakdown-label {
        color: var(--text-main);
        font-weight: 600;
    }

    /* Analyzed Thumb Image */
    .analyzed-thumb {
        width: 100%;
        height: 100px;
        object-fit: cover;
        border: 1px solid #ddd;
    }


    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 14px 32px;
        font-family: 'Inter', sans-serif;
        font-size: 15px;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        border: 1px solid transparent;
        border-radius: 0;
    }

    .btn-primary {
        background: var(--text-main);
        color: #fff;
        border-color: var(--text-main);
    }

    .btn-primary:hover {
        background: #000;
    }

    .btn-secondary {
        background: #fff;
        border-color: #ccc;
        color: var(--text-main);
    }

    .btn-secondary:hover {
        background: #f5f5f5;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 3px solid #eee;
        border-top-color: var(--text-main);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 16px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    /* Responsive */
    @media (max-width: 600px) {
        .results-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ai-wrapper">
    <div class="ai-container">

        <header style="margin-bottom: 24px;">
            <a href="{% url 'profile_settings' %}" class="btn btn-secondary"
                style="padding: 8px 16px; font-size: 13px;">
                ‚Üê Back to Settings
            </a>
        </header>

        {% if messages %}
        <div class="messages" style="margin-bottom: 24px;">
            {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% endif %}" style="padding: 15px; margin-bottom: 20px; border: 1px solid transparent; border-radius: 4px; {% if message.tags == 'error' %}color: #721c24; background-color: #f8d7da; border-color: #f5c6cb;{% elif message.tags == 'success' %}color: #155724; background-color: #d4edda; border-color: #c3e6cb;{% elif message.tags == 'warning' %}color: #856404; background-color: #fff3cd; border-color: #ffeeba;{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if analyzed %}
        <!-- RESULTS VIEW -->
        <div class="steps-header">
            <h1 class="steps-title">Style Analysis Complete</h1>
            <p class="steps-subtitle">Based on your uploads, here is your unique style profile.</p>
        </div>

        <form method="post">
            {% csrf_token %}
            <input type="hidden" name="save_profile" value="true">

            <div class="results-grid">
                <!-- Persona -->
                <div class="persona-card">
                    <div class="persona-title">Your Style Persona</div>
                    <div class="persona-value">{{ detected_persona }}</div>
                    <p style="margin-top: 12px; font-size: 14px; color: var(--text-muted);">
                        Derived from analyzing {{ results|length }} images.
                    </p>

                    {% for style in detected_styles %}
                    <input type="hidden" name="preferred_styles" value="{{ style }}">
                    {% endfor %}
                </div>

                <!-- Colors -->
                <div class="persona-card">
                    <div class="persona-title">Dominant Palette</div>
                    <div class="palette-row">
                        {% for color in detected_colors %}
                        <div class="palette-swatch" style="background-color: {{ color.hex }};" title="{{ color.name }}">
                        </div>
                        <input type="hidden" name="detected_colors" value="{{ color.name }}">
                        {% empty %}
                        <span style="color: #999;">No consistent colors detected.</span>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Detailed Breakdown -->
            <div class="image-breakdown-card">
                <h3 style="font-size: 16px; margin-bottom: 16px; font-weight: 600;">Image Analysis Breakdown</h3>
                <div class="image-strip">
                    {% for result in results %}
                    <div class="breakdown-item">
                        <!-- Filename Truncated -->
                        <!-- Image Preview -->
                        <div style="width: 100%; margin-bottom: 12px;">
                            {% if result.image_base64 %}
                            <img src="{{ result.image_base64 }}" class="analyzed-thumb" alt="{{ result.name }}"
                                style="width: 100%; height: 100px; object-fit: cover;">
                            {% else %}
                            <div class="breakdown-thumb-placeholder" title="{{ result.name }}">
                                {{ result.name|truncatechars:20 }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="breakdown-info">
                            <div class="breakdown-text">
                                <span class="breakdown-label">Style:</span> {{ result.analysis.style|default:"-" }}
                            </div>
                            <div class="breakdown-text">
                                <span class="breakdown-label">Color:</span> {{ result.analysis.color|default:"-" }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div style="text-align: center; margin-top: 40px;">
                <button type="submit" class="btn btn-primary">Apply to My Profile</button>
                <a href="{% url 'ai_style_analyze' %}" class="btn btn-secondary" style="margin-left: 12px;">Start
                    Over</a>
            </div>
        </form>

        {% else %}
        <!-- UPLOAD VIEW -->
        <div class="steps-header">
            <h1 class="steps-title">AI Style Assistant</h1>
            <p class="steps-subtitle">Upload 3-5 photos of outfits you love. Our AI will detect your style persona.</p>
        </div>

        <div class="ai-card">
            <form method="post" enctype="multipart/form-data" id="uploadForm">
                {% csrf_token %}
                <input type="hidden" name="analyze" value="true">

                <div class="upload-zone" id="dropZone">
                    <input type="file" name="style_images" multiple accept="image/*" class="upload-input" id="fileInput"
                        onchange="handleFiles(this.files)">
                    <div id="uploadContent">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="1.5"
                            style="margin-bottom: 16px;">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <h3 style="font-size: 18px; margin-bottom: 8px; color: var(--text-main);">Drag & Drop Photos
                        </h3>
                        <p style="color: #999; font-size: 14px;">or click to browse</p>
                    </div>
                    <div id="filePreview" style="display: none; margin-top: 20px;">
                        <p id="fileCount" style="font-weight: 600; margin-bottom: 12px;"></p>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;"
                            id="previewStrip"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 32px;">
                    <button type="submit" class="btn btn-primary" id="analyzeBtn" disabled style="opacity: 0.5;">
                        Analyze My Style
                    </button>
                </div>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <h3 style="font-family: 'Istok Web'; font-size: 24px; margin-bottom: 8px;">Analyzing...</h3>
    <p style="color: #666;">Identifying patterns, colors, and aesthetics.</p>
</div>

<script>
    function handleFiles(files) {
        if (files.length > 0) {
            document.getElementById('uploadContent').style.display = 'none';
            document.getElementById('filePreview').style.display = 'block';
            document.getElementById('fileCount').textContent = `${files.length} images selected`;

            const btn = document.getElementById('analyzeBtn');
            btn.disabled = false;
            btn.style.opacity = '1';

            const previewStrip = document.getElementById('previewStrip');
            previewStrip.innerHTML = '';

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'analyzed-thumb';
                    img.style.width = '80px';
                    img.style.height = '80px';
                    previewStrip.appendChild(img);
                }
                reader.readAsDataURL(file);
            });
        }
    }

    const form = document.getElementById('uploadForm');
    if (form) {
        form.addEventListener('submit', function () {
            document.getElementById('loadingOverlay').style.display = 'flex';
        });
    }

    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
        });

        dropZone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            document.getElementById('fileInput').files = files;
            handleFiles(files);
        }
    }
</script>
{% endblock %}